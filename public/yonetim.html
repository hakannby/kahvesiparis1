<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Yönetici Paneli</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  

  <style>
    :root {
      --primary: #3498db;
      --danger: #e74c3c;
      --success: #27ae60;
      --warning: #f39c12;
      --dark: #2c3e50;
      --light: #f8f9fa;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 25px;
      background-color: #f0f2f5;
      color: #333;
      max-width: 1400px;
      margin: 0 auto;
      line-height: 1.6;
    }
    
    h1, h2, h3, h4 {
      color: var(--dark);
      margin-bottom: 20px;
    }
    
    h1, h2 {
      text-align: center;
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #ddd;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .section {
      background: #fff;
      padding: 25px;
      margin-bottom: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid #eaeaea;
    }
    
    .section-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .flex-container {
      display: flex;
      gap: 30px;
      margin-top: 20px;
    }
    
    .flex-container > div {
      flex: 1;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    input:focus, select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      outline: none;
    }
    
    button {
      padding: 12px 20px;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn-primary {
      background-color: var(--primary);
    }
    
    .btn-primary:hover {
      background-color: #2980b9;
    }
    
    .btn-success {
      background-color: var(--success);
    }
    
    .btn-success:hover {
      background-color: #219653;
    }
    
    .btn-danger {
      background-color: var(--danger);
    }
    
    .btn-danger:hover {
      background-color: #c0392b;
    }
    
    .btn-warning {
      background-color: var(--warning);
    }
    
    .btn-warning:hover {
      background-color: #e67e22;
    }
    
    .logout-btn {
      background-color: var(--danger);
      padding: 10px 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    th, td {
      border: 1px solid #e0e0e0;
      padding: 12px 15px;
      text-align: left;
    }
    
    th {
      background-color: #f2f6fc;
      font-weight: 600;
      color: var(--dark);
      position: sticky;
      top: 0;
    }
    
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    tr:hover {
      background-color: #f0f7ff;
    }
    
    .action-cell {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      padding: 6px 10px;
      font-size: 14px;
    }
    
    .message {
      margin-top: 15px;
      font-weight: 500;
      padding: 12px;
      border-radius: 8px;
      display: none;
    }
    
    .error {
      color: var(--danger);
      background-color: #fdeded;
    }
    
    .success {
      color: var(--success);
      background-color: #edf7f0;
    }
    
    .warning {
      color: var(--warning);
      background-color: #fef5e7;
    }
    
    .ingredient-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
    }
    
    .ingredient-row select, 
    .ingredient-row input {
      flex: 1;
      margin: 0;
    }
    
    .ingredient-row button {
      margin: 0;
      padding: 8px 12px;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 6px;
      background: #f1f1f1;
      transition: all 0.3s;
    }
    
    .tab.active {
      background: var(--primary);
      color: white;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #777;
    }
    
    .history-item {
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .history-item:hover {
      background: #f0f7ff;
    }
    
    .status-low {
      color: var(--danger);
      font-weight: bold;
    }
    
    .status-ok {
      color: var(--success);
      font-weight: bold;
    }
    
    .category-item {
      padding: 12px 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .subcategory-item {
      padding: 10px 15px;
      background: #e3f2fd;
      border-radius: 6px;
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #bbdefb;
    }
    
    .category-item strong {
      color: #2c3e50;
      font-size: 16px;
    }
    
    .subcategory-item {
      color: #1565c0;
      font-size: 14px;
    }
    
    @media (max-width: 992px) {
      .flex-container {
        flex-direction: column;
        gap: 20px;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .section {
        padding: 20px;
      }
      
      table {
        font-size: 14px;
      }
      
      th, td {
        padding: 10px;
      }
    }

    /* PDF Stilleri */
    .pdf-title {
      font-size: 20px;
      color: #2c3e50;
      text-align: center;
      margin-bottom: 10px;
    }
    .pdf-section {
      background-color: #f8f9fa;
      border-left: 4px solid #a97443;
      padding: 8px;
      margin: 10px 0;
    }
    .pdf-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    .pdf-table th {
      background-color: #a97443;
      color: white;
      padding: 8px;
      text-align: left;
    }
    .pdf-table td {
      padding: 8px;
      border-bottom: 1px solid #ddd;
    }
    .pdf-highlight {
      color: #27ae60;
      font-weight: bold;
    }



    .canceled-row {
      background-color: #ffeeee !important;
    }
    .status-canceled {
      color: var(--danger);
      font-weight: bold;
    }

     .history-table {
      font-size: 13px;
    }
    .history-table th, 
    .history-table td {
      padding: 8px 10px;
    }

      .paid-cell {
  color: #27ae60; /* yeşil */
  font-weight: bold;
}
.payable-cell {
  color: #e74c3c; /* kırmızı */
  font-weight: bold;
}

    #stockExpensesTable th, 
#stockExpensesTable td {
  padding: 10px;
  font-size: 14px;
}


  /* Boyut seçenekleri için stil */
.size-option-container {
  display: flex;
  gap: 15px;
  margin: 10px 0;
}

.size-option {
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  text-align: center;
  width: 80px;
}

.size-option:hover {
  background-color: #f0f0f0;
}

.size-option.selected {
  border-color: #3498db;
  background-color: #e3f2fd;
}

.size-icon {
  font-size: 24px;
  margin-bottom: 5px;
  color: #a97443;
}

    .sortable-list {
  cursor: grab;
}

.sortable-item {
  transition: transform 0.2s;
}

.sortable-item.dragging {
  opacity: 0.5;
  background: #e3f2fd;
  border: 1px dashed #3498db;
}

.sortable-placeholder {
  height: 40px;
  background: #f0f7ff;
  border: 2px dashed #3498db;
  margin: 5px 0;
}

    
  </style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
  <div class="panel-header">
    <h1>Yönetici Paneli</h1>
    <button class="logout-btn" onclick="window.location.href='index.html'">
      <i class="fas fa-sign-out-alt"></i> Çıkış Yap
    </button>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="dashboard">Ana Panel</div>
    <div class="tab" data-tab="stock">Stok Yönetimi</div>
    <div class="tab" data-tab="products">Ürün/Kategori Yönetimi</div>
    <div class="tab" data-tab="history">Geçmiş İşlemler</div>
    <div class="tab" data-tab="settings">Kullanıcılar</div>
    <!-- <div class="tab" data-tab="accounting">ÖN MUHASEBE</div>
    <div class="tab" data-tab="expenseArchive">Gider Arşiv</div> -->

  </div>

  <div class="tab-content" id="expenseArchive">
  <div class="section">
    <h2>Gider Arşiv</h2>
    
    <div class="tabs" style="margin-bottom: 20px;">
      <div class="tab active" data-subtab="dekont">Dekont</div>
      <div class="tab" data-subtab="cari">Cari</div>
    </div>
    
    <!-- Dekont Tablosu -->
    <div class="subtab-content active" id="dekontTab">
      <div class="section">
        <h3>Dekont Giderleri</h3>
        <table id="dekontTable">
          <thead>
            <tr>
              <th>Fatura Adı</th>
              <th>Açıklama</th>
              <th>Birim Fiyat (₺)</th>
              <th>Adet</th>
              <th>Toplam (₺)</th>
              <th>KDV Tutarı (₺)</th>
              <th>Toplam (KDV Dahil) (₺)</th>
              <th>Ödenen (₺)</th>
              <th>Tarih</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="9" style="text-align:center;">Dekont gideri bulunamadı</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Cari Tablosu -->
    <div class="subtab-content" id="cariTab">
      <div class="section">
        <h3>Cari Giderleri</h3>
        <table id="cariTable">
          <thead>
            <tr>
              <th>Fatura Adı</th>
              <th>Açıklama</th>
              <th>Birim Fiyat (₺)</th>
              <th>Adet</th>
              <th>Toplam (₺)</th>
              <th>KDV Tutarı (₺)</th>
              <th>Toplam (KDV Dahil) (₺)</th>
              <th>Ödenecek (₺)</th>
              <th>Tarih</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="9" style="text-align:center;">Cari gideri bulunamadı</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>





<div class="tab-content" id="accounting">
  <div class="section">
    <h2>ÖN MUHASEBE</h2>
      <!-- Stok Giderleri Bölümü -->
    <div class="section">
      <div class="section-title">
        <h3>Stok Giderleri</h3>
        <button class="btn-primary" onclick="openAddStockExpenseModal()">
          <i class="fas fa-plus"></i> Stok Gideri Ekle
        </button>
      </div>
      
      <table id="stockExpensesTable">
        <thead>
          <tr>
            <th>Fatura Adı</th>
            <th>Açıklama</th>
            <th>Birim Fiyat (₺)</th>
            <th>Adet</th>
            <th>Toplam (₺)</th>
            <th>KDV Tutarı (₺)</th>
            <th>KDV'li Toplam (₺)</th>
            <th>Tarih</th>
            <th>İşlemler</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="9" style="text-align:center;">Stok gideri bulunamadı</td>
          </tr>
        </tbody>
      </table>
    </div>


    <!-- Diğer Giderler Bölümü -->
    <div class="section">
      <h3>Diğer Giderler</h3>
      <p>Bu bölüm geliştirme aşamasındadır.</p>
    </div>
  </div>
</div>





  <!-- Ana Panel -->
  <div class="tab-content active" id="dashboard">
    <div class="section">
      <h2>Sistem Özeti</h2>
      <div class="flex-container">
        <div class="section">
          <h3>Stok Durumu</h3>
          <table id="stokTablosu">
            <thead>
              <tr>
                <th>Ürün Adı</th>
                <th>Stok Miktarı</th>
                <th>Birim</th>
                <th>Durum</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="4" style="text-align:center;">Stok verileri yükleniyor...</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="section">
          <h3>Son Siparişler</h3>
          <table id="sonSiparisler">
            <thead>
              <tr>
                <th>Personel</th>
                <th>Tutar</th>
                <th>Tarih</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" style="text-align:center;">Sipariş geçmişi yükleniyor...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Stok Yönetimi -->
  <div class="tab-content" id="stock">
    <div class="section">
      <div class="section-title">
        <h2>Stok Yönetimi</h2>
      </div>
      
      <div class="flex-container">
        <div>
          <h3>Yeni Stok Ürünü Ekle</h3>
          <div class="form-group">
            <label>Ürün Adı:</label>
            <input type="text" id="urunAdi" placeholder="Örn: Çikolata Sosu">
          </div>
          
          <div class="form-group">
            <label>Başlangıç Stok Miktarı:</label>
            <input type="number" id="urunStok" min="0" placeholder="Örn: 1000">
          </div>
          
          <div class="form-group">
            <label>Birim:</label>
            <select id="urunBirim">
              <option value="ml">ml</option>
              <option value="litre">litre</option>
              <option value="g">g</option>
              <option value="kg">kg</option>
              <option value="adet">adet</option>
              <option value="kutu">kutu</option>
              <option value="sise">sise</option>
              <option value="paket">paket</option>
              <option value="olcu">olcu</option>
            </select>
          </div>
          
          <button class="btn-success" onclick="urunEkle()">
            <i class="fas fa-plus"></i> Ürün Ekle
          </button>
          <div id="urunEkleMessage" class="message"></div>
        </div>
        
        <div>
          <h3>Mevcut Stok İlave</h3>
          <div class="form-group">
            <label>Ürün Seç:</label>
            <select id="guncelleSec">
              <option value="">-- Ürün seçin --</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Eklenen Stok Miktarı:</label>
            <input type="number" id="eklenenStok" min="0" placeholder="Örn: 500">
          </div>
          
          <button class="btn-primary" onclick="stokEkle()">
            <i class="fas fa-plus-circle"></i> Stok Ekle
          </button>
          <div id="stokEkleMessage" class="message"></div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h3>Stok Geçmişi</h3>
      <div class="form-group">
        <label>Ürün Seç:</label>
        <select id="stokGecmisiSec">
          <option value="">-- Ürün seçin --</option>
        </select>
      </div>
      
      <table id="stokGecmisiTablosu">
        <thead>
          <tr>
            <th>Tarih</th>
            <th>İşlem</th>
            <th>Miktar</th>
            <th>Kullanıcı</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" style="text-align:center;">Ürün seçiniz...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Ürün Yönetimi -->
  <div class="tab-content" id="products">
    <div class="section">
  <div class="section-title">
    <h2>Kategori Yönetimi</h2>
    <button class="btn-primary" onclick="openCategoryModal()">
      <i class="fas fa-plus"></i> Yeni Kategori
    </button>
  </div>
  
  <div class="flex-container">
    <div>
      <h3>Kategori Hierarşisi</h3>
      <div id="categoryTree">
  <ul id="categoryList" style="list-style-type: none; padding-left: 0;" class="sortable-list">
    <!-- Kategoriler buraya eklenecek -->
  </ul>
</div>
      
      <h3 style="margin-top: 20px;">Yeni Ürün Ekle</h3>
      <div class="form-group">
        <label>Ürün Adı:</label>
        <input type="text" id="newProductName" placeholder="Örn: Cold Brew">
      </div>
      
      <!-- Boyut seçeneklerini buraya ekleyin -->
      <div class="form-group">
        <label>
          <input type="checkbox" id="enableSizes"> Bu ürünün boyut seçenekleri var
        </label>
      </div>
      
      <div id="sizeOptions" style="display:none; margin-bottom:15px;">
        <div class="size-option-container">
          <div class="size-option" onclick="document.getElementById('sizeSmall').click()">
            <input type="checkbox" id="sizeSmall" style="display:none">
            <div class="size-icon"><i class="fas fa-coffee"></i></div>
            <div>Küçük</div>
          </div>
          
          <div class="size-option" onclick="document.getElementById('sizeMedium').click()">
            <input type="checkbox" id="sizeMedium" style="display:none">
            <div class="size-icon"><i class="fas fa-mug-hot"></i></div>
            <div>Orta</div>
          </div>
          
          <div class="size-option" onclick="document.getElementById('sizeLarge').click()">
            <input type="checkbox" id="sizeLarge" style="display:none">
            <div class="size-icon"><i class="fas fa-beer"></i></div>
            <div>Büyük</div>
          </div>
        </div>
        
        <div id="sizePriceFields" style="display:none; margin-top:15px;">
          <div id="smallPriceField" style="display:none; margin-bottom:10px;">
            <label>Küçük Boy Fiyatı (₺):</label>
            <input type="number" id="priceSmall" min="0" step="0.01" placeholder="Fiyat">
          </div>
          
          <div id="mediumPriceField" style="display:none; margin-bottom:10px;">
            <label>Orta Boy Fiyatı (₺):</label>
            <input type="number" id="priceMedium" min="0" step="0.01" placeholder="Fiyat">
          </div>
          
          <div id="largePriceField" style="display:none; margin-bottom:10px;">
            <label>Büyük Boy Fiyatı (₺):</label>
            <input type="number" id="priceLarge" min="0" step="0.01" placeholder="Fiyat">
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label>Fiyat (₺):</label>
        <input type="number" id="newProductPrice" placeholder="Örn: 120" min="0" step="0.01">
      </div>
      
      <div class="form-group">
        <label>Kategori:</label>
        <select id="newProductCategory">
          <option value="">-- Kategori seçin --</option>
        </select>
      </div>
      
      <h4 style="margin-top: 20px;">Standart İçerikler</h4>
      <div id="ingredientList"></div>
      <button class="btn-primary" onclick="addIngredientField()">
        <i class="fas fa-plus"></i> İçerik Ekle
      </button>
      
      <div id="sizeIngredientSections" style="display:none; margin-top:20px;">
        <div id="smallIngredientsSection" style="display:none;">
          <h4>Küçük Boy İçerikleri</h4>
          <div id="smallIngredientList"></div>
          <button class="btn-primary" onclick="addSmallIngredientField()">
            <i class="fas fa-plus"></i> İçerik Ekle
          </button>
        </div>
        
        <div id="mediumIngredientsSection" style="display:none;">
          <h4>Orta Boy İçerikleri</h4>
          <div id="mediumIngredientList"></div>
          <button class="btn-primary" onclick="addMediumIngredientField()">
            <i class="fas fa-plus"></i> İçerik Ekle
          </button>
        </div>
        
        <div id="largeIngredientsSection" style="display:none;">
          <h4>Büyük Boy İçerikleri</h4>
          <div id="largeIngredientList"></div>
          <button class="btn-primary" onclick="addLargeIngredientField()">
            <i class="fas fa-plus"></i> İçerik Ekle
          </button>
        </div>
      </div>
      
      <button class="btn-success" onclick="saveNewProduct()" style="margin-top: 20px;">
        <i class="fas fa-save"></i> Ürünü Kaydet
      </button>
      <div id="productMessage" class="message"></div>
    </div>
    
    <div>
      <h3>Mevcut Ürünler</h3>
      <table id="productTable">
        <thead>
          <tr>
            <th>Ad</th>
            <th>Fiyat</th>
            <th>Kategori</th>
            <th>İşlemler</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" style="text-align:center;">Ürünler yükleniyor...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
  </div>

  <!-- Geçmiş İşlemler -->
  <div class="tab-content" id="history">
    <div class="section">
      <h2>Son İşlemler</h2>
      
      <div class="flex-container">
        <div class="section">
          <h3>Son Stok İşlemleri</h3>
          <table id="stokIslemleri" class="history-table">
            <thead>
              <tr>
                <th>Seç</th>
                <th>Tarih</th>
                <th>Ürün</th>
                <th>Miktar</th>
                <th>İşlem</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" style="text-align:center;">İşlem geçmişi yükleniyor...</td>
              </tr>
            </tbody>
          </table>
          
          <button class="btn-warning" onclick="cancelStockOperation()" style="margin-top: 20px;">
            <i class="fas fa-undo"></i> İşlemi İptal Et
          </button>
          <button class="btn-primary" onclick="openStockReportModal()" style="margin-top: 20px; margin-left: 10px;">
            <i class="fas fa-file-pdf"></i> Stok Geçmiş Raporu Oluştur
          </button>
        </div>
        
        <div class="section">
          <h3>Son Siparişler</h3>
          <table id="siparisTablosu" class="history-table">
            <thead>
              <tr>
                <th>Seç</th>
                <th>Personel</th>
                <th>Ürünler</th>
                <th>Toplam</th>
                <th>Tarih</th>
                <th>Durum</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                 <td colspan="6" style="text-align:center;">Sipariş geçmişi yükleniyor...</td>
              </tr>
            </tbody>
          </table>
          
          <button class="btn-warning" onclick="cancelSelectedOrder()" style="margin-top: 20px;">
            <i class="fas fa-ban"></i> İşlemi İptal Et
          </button>
          <button class="btn-primary" onclick="openOrderReportModal()" style="margin-top: 20px; margin-left: 10px;">
             <i class="fas fa-file-pdf"></i> Sipariş Raporu Oluştur
          </button>

        </div>
      </div>
    </div>
  </div>

  <!-- Rapor Oluşturma Butonu -->
  <button class="btn-primary" onclick="openReportModal()">
    <i class="fas fa-file-pdf"></i> Günlük Rapor Oluştur
  </button>



    <!-- Stok Rapor Modalı -->
<div id="stockReportModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Stok Geçmiş Raporu</h3>
      <button class="close-btn" onclick="closeModal('stockReportModal')">&times;</button>
    </div>
    <div class="form-group">
      <label>Başlangıç Tarihi:</label>
      <input type="date" id="stockReportStartDate">
    </div>
    <div class="form-group">
      <label>Bitiş Tarihi:</label>
      <input type="date" id="stockReportEndDate">
    </div>
    <button class="btn-success" onclick="generateStockReport()">
      <i class="fas fa-file-export"></i> Rapor Oluştur
    </button>
    <div id="stockReportMessage" class="message"></div>
  </div>
</div>



    <!-- Sipariş Rapor Modalı -->
<div id="orderReportModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Sipariş Raporu</h3>
      <button class="close-btn" onclick="closeModal('orderReportModal')">&times;</button>
    </div>
    <div class="form-group">
      <label>Başlangıç Tarihi:</label>
      <input type="date" id="orderReportStartDate">
    </div>
    <div class="form-group">
      <label>Bitiş Tarihi:</label>
      <input type="date" id="orderReportEndDate">
    </div>
    
    <div class="form-group">
      <label>Rapor İçeriği:</label>
      <div style="margin-top: 10px;">
        <label style="display: block; margin-bottom: 8px;">
          <input type="checkbox" id="reportOptionSales" value="sales" checked> Ürün Satış Adetleri
        </label>
        <label style="display: block; margin-bottom: 8px;">
          <input type="checkbox" id="reportOptionRevenue" value="revenue" checked> Ciro
        </label>
        <label style="display: block; margin-bottom: 8px;">
          <input type="checkbox" id="reportOptionDetails" value="details"> Tüm Sipariş Detayı
        </label>
      </div>
    </div>
    
    <button class="btn-success" onclick="generateOrderReport()">
      <i class="fas fa-file-export"></i> Rapor Oluştur
    </button>
    <div id="orderReportMessage" class="message"></div>
  </div>
</div>




  <!-- Rapor Modal Penceresi -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Günlük Rapor Oluştur</h3>
        <button class="close-btn" onclick="closeModal('reportModal')">&times;</button>
      </div>
      <div class="form-group">
        <label for="reportDate">Rapor Tarihi:</label>
        <input type="date" id="reportDate">
      </div>
      <button class="btn-success" onclick="generateReport()">
        <i class="fas fa-file-export"></i> Rapor Oluştur
      </button>
      <div id="reportMessage" class="message"></div>
      <div id="reportLink" style="margin-top: 20px; display: none;">
        <a id="reportDownloadLink" target="_blank" class="btn-primary">
          <i class="fas fa-download"></i> Raporu İndir
        </a>
      </div>
    </div>
  </div>

  <!-- Ayarlar -->
  <div class="tab-content" id="settings">
    <div class="section">
      <h2>Sistem Ayarları</h2>
      
      <div class="flex-container">
        <div>
          <h3>Kullanıcı Yönetimi</h3>
          <table id="userTable">
            <thead>
              <tr>
                <th>E-posta</th>
                <th>Rol</th>
                <th>İşlemler</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="3" style="text-align:center;">Kullanıcılar yükleniyor...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>







  <!-- Modal HTML (sayfanın en altına, diğer modal'ların yanına ekle) ÖN MUHASEBE -->
<div id="stockExpenseModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Stok Gideri Ekle</h3>
      <button class="close-btn" onclick="closeModal('stockExpenseModal')">&times;</button>
    </div>
    <div class="form-group">
      <label>Fatura Adı:</label>
      <input type="text" id="expenseInvoiceName" placeholder="Fatura adı girin">
    </div>
    <div class="form-group">
      <label>Açıklama:</label>
      <textarea id="expenseDescription" rows="2" placeholder="Açıklama girin"></textarea>
    </div>
    <div class="form-group">
      <label>Birim Fiyat (₺):</label>
      <input type="number" id="expenseUnitPrice" min="0" step="0.01" placeholder="Birim fiyat">
    </div>
    <div class="form-group">
      <label>Satın Alınan Adet:</label>
      <input type="number" id="expenseQuantity" min="1" placeholder="Adet">
    </div>
    <div class="form-group">
      <label>KDV Oranı (%):</label>
      <input type="number" id="expenseTaxRate" min="0" max="100" value="18" placeholder="KDV oranı">
    </div>
    <div class="form-group">
  <label>Ödenen (₺):</label>
  <input type="number" id="expensePaid" min="0" step="0.01" placeholder="Ödenen tutar">
</div>
<div class="form-group">
  <label>Ödenecek (₺):</label>
  <input type="number" id="expensePayable" min="0" step="0.01" placeholder="Ödenecek tutar">
</div>
    <button class="btn-success" onclick="saveStockExpense()">
      <i class="fas fa-save"></i> Kaydet
    </button>
    <div id="stockExpenseMessage" class="message"></div>
  </div>
</div>





  <!-- Kategori Modal -->
  <div id="categoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Yeni Kategori Ekle</h3>
        <button class="close-btn" onclick="closeModal('categoryModal')">&times;</button>
      </div>
      
      <div class="form-group">
        <label>Kategori Adı:</label>
        <input type="text" id="modalCategoryName" placeholder="Örn: Soğuk İçecekler">
      </div>
      
      <div class="form-group">
        <label>Kategori Türü:</label>
        <div style="display: flex; gap: 10px; margin-top: 8px;">
          <label style="display: flex; align-items: center;">
            <input type="radio" name="categoryType" value="main" checked onchange="toggleParentSelect()"> Ana Kategori
          </label>
          <label style="display: flex; align-items: center;">
            <input type="radio" name="categoryType" value="sub" onchange="toggleParentSelect()"> Alt Kategori
          </label>
        </div>
      </div>
      
      <div class="form-group" id="parentCategoryGroup" style="display:none">
        <label>Üst Kategori Seçin:</label>
        <select id="parentCategorySelect">
          <option value="">-- Üst kategori seçin --</option>
        </select>
      </div>
      
      <button class="btn-success" onclick="saveCategory()">
        <i class="fas fa-save"></i> Kaydet
      </button>
      <div id="modalCategoryMessage" class="message"></div>
    </div>
  </div>

  <!-- İade Modal -->
  <div id="refundModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>İade/Değişim</h3>
        <button class="close-btn" onclick="closeModal('refundModal')">&times;</button>
      </div>
      
      <h4>Son 10 Sipariş</h4>
      <div id="lastOrdersList" style="max-height: 300px; overflow-y: auto; margin: 15px 0;">
        <div class="history-item">
          <div><strong>#1234</strong> - Ahmet Yılmaz (85₺)</div>
          <div>2x Cappuccino, 1x Cheesecake</div>
          <div>22.07.2025 14:30</div>
        </div>
        <div class="history-item">
          <div><strong>#1235</strong> - Ayşe Demir (45₺)</div>
          <div>1x Latte, 1x Muffin</div>
          <div>22.07.2025 13:15</div>
        </div>
        <div class="history-item">
          <div><strong>#1236</strong> - Mehmet Kaya (65₺)</div>
          <div>1x Espresso, 1x Brownie</div>
          <div>22.07.2025 12:45</div>
        </div>
      </div>
      
      <div class="form-group" style="margin-top: 20px;">
        <label>İade Sebebi:</label>
        <textarea id="refundReason" rows="3" placeholder="İade sebebini belirtin..."></textarea>
      </div>
      
      <button class="btn-warning" onclick="processRefund()" style="width: 100%;">
        <i class="fas fa-exchange-alt"></i> İade/Değişim Yap
      </button>
    </div>
  </div>

        



  <script>
    // Firebase konfigürasyonu
    const firebaseConfig = {
      apiKey: "AIzaSyCyOAbT9CM76LvWrUYM4ZCl078O7mKmx_o",
      authDomain: "kahvesiparis1.firebaseapp.com",
      projectId: "kahvesiparis1",
      storageBucket: "kahvesiparis1.appspot.com",
      messagingSenderId: "358382107079",
      appId: "1:358382107079:web:37ccd0e80b73736a8681e2"
    };

    // Firebase başlatma
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Global değişkenler
    let allIngredients = [];
    let allProducts = [];
    let allCategories = [];
    let currentUser = null;

    // Tarih formatlama fonksiyonu
    function formatFirestoreDate(timestamp) {
      if (!timestamp || typeof timestamp.toDate !== 'function') return "-";
      try {
        return timestamp.toDate().toLocaleString("tr-TR");
      } catch (e) {
        return "-";
      }
    }

    // Sayfa yüklendiğinde çalışacak fonksiyon
    document.addEventListener('DOMContentLoaded', function() {
      // Tab kontrolü
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
          
          // Geçmiş işlemler sekmesi aktif olduğunda sipariş geçmişini yükle
          if (tab.dataset.tab === 'history') {
            loadOrderHistory();
          }

           if (tab.dataset.tab === 'accounting') {
        loadStockExpenses();
      }
      if (tab.dataset.tab === 'expenseArchive') {
      // Gider Arşiv sekmesi aktif
      // Varsayılan olarak Dekont tablosunu yükle
      loadDekontExpenses();
    }

      
        });
      });


          // Gider Arşiv sekmesi içindeki alt sekmeler
document.querySelectorAll('#expenseArchive .tab[data-subtab]').forEach(tab => {
  tab.addEventListener('click', function() {
    // Aktif tabı değiştir
    document.querySelectorAll('#expenseArchive .tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('#expenseArchive .subtab-content').forEach(c => c.classList.remove('active'));
    
    this.classList.add('active');
    document.getElementById(this.dataset.subtab + 'Tab').classList.add('active');
    
    // Tabloları yükle
    if (this.dataset.subtab === 'dekont') {
      loadDekontExpenses();
    } else if (this.dataset.subtab === 'cari') {
      loadCariExpenses();
    }
  });
});















      // Kullanıcı oturum kontrolü
      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          alert("Bu sayfayı görüntülemek için giriş yapmalısınız");
          window.location.href = "index.html";
          return;
        }

        currentUser = user;
        
        try {
          const userRef = db.collection("users").doc(user.uid);
          const userSnap = await userRef.get();
          
          if (!userSnap.exists || userSnap.data().role !== "yonetici") {
            alert("Bu sayfayı görüntülemek için yetkiniz yok");
            window.location.href = "index.html";
            return;
          }

          // Sayfa başlatma
          initPage();
        } catch (error) {
          console.error("Yetki kontrol hatası:", error);
          alert("Yetki kontrolü sırasında hata oluştu");
          window.location.href = "index.html";
        }
      });

       // Sıralama özelliğini başlat - DÜZELTİLDİ (setTimeout eklendi)
  setTimeout(() => {
    initSortableCategories();
  }, 1000);
});

    async function initPage() {
      await loadStocks();
      await loadIngredients();
      await loadCategories();
      await loadProducts();
      await loadUsers();
      
      // Dashboard verilerini yükle
      loadDashboardData();
      
      // Stok geçmişi dropdown event listener
      document.getElementById('stokGecmisiSec').addEventListener('change', async function() {
        if (this.value) {
          await loadProductStockHistory(this.value);
        } else {
          document.querySelector("#stokGecmisiTablosu tbody").innerHTML = 
            `<tr><td colspan="4" style="text-align:center;">Ürün seçiniz...</td></tr>`;
        }
      });
    }




      // SortableJS kütüphanesini yükle
function loadSortableJS() {
  return new Promise((resolve) => {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js';
    script.onload = resolve;
    document.head.appendChild(script);
  });
}

// Kategori sıralamasını başlat
async function initSortableCategories() {
  await loadSortableJS();
  
  new Sortable(document.getElementById('categoryList'), {
    animation: 150,
    ghostClass: 'sortable-item',
    dragClass: 'dragging',
    handle: '.category-item',
    onEnd: async function() {
      await updateCategoryOrder();
    }
  });
}

// Firestore'da sıralamayı güncelle
async function updateCategoryOrder() {
  const categories = [];
  const items = document.querySelectorAll('#categoryList > li');
  
  items.forEach((item, index) => {
    const categoryId = item.getAttribute('data-id');
    if (categoryId) {
      categories.push({
        id: categoryId,
        order: index
      });
    }
  });

  try {
    const batch = db.batch();
    categories.forEach(cat => {
      const ref = db.collection("categories").doc(cat.id);
      batch.update(ref, { order: cat.order });
    });
    
    await batch.commit();
    showMessage('categoryMessage', '✔️ Kategori sıralaması güncellendi', 'success');
  } catch (error) {
    console.error("Sıralama güncelleme hatası:", error);
    showMessage('categoryMessage', '❌ Hata: ' + error.message, 'error');
  }
}






        async function loadDekontExpenses() {
  try {
    const querySnapshot = await db.collection(EXPENSES_COLLECTION)
      .where("type", "==", "stock")
      .where("paidAmount", ">", 0)
      .orderBy("paidAmount", "desc") // Önce ödenen tutara göre sırala
      .orderBy("date", "desc") // Sonra tarihe göre sırala
      .get();

    updateDekontTable(querySnapshot);
  } catch (error) {
    console.error("Dekont giderleri yüklenirken hata:", error);
    const tbody = document.querySelector("#dekontTable tbody");
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:red;">Hata: ${error.message}</td></tr>`;
  }
}

function updateDekontTable(snapshot) {
  const tbody = document.querySelector("#dekontTable tbody");
  if (snapshot.empty) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Dekont gideri bulunamadı</td></tr>`;
    return;
  }

  let tbodyContent = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    const date = formatFirestoreDate(data.date);
    const taxAmount = (data.total * data.taxRate) / 100;

    tbodyContent += `
      <tr>
        <td>${data.invoiceName}</td>
        <td>${data.description}</td>
        <td>${data.unitPrice.toFixed(2)}</td>
        <td>${data.quantity}</td>
        <td>${data.total.toFixed(2)}</td>
        <td>${taxAmount.toFixed(2)}</td>
        <td>${data.totalWithTax.toFixed(2)}</td>
        <td class="paid-cell">${data.paidAmount.toFixed(2)}</td>
        <td>${date}</td>
      </tr>
    `;
  });

  tbody.innerHTML = tbodyContent;
}








// Boyut seçeneklerini yönetmek için yeni fonksiyonlar
document.getElementById('enableSizes').addEventListener('change', function() {
  const sizeOptions = document.getElementById('sizeOptions');
  sizeOptions.style.display = this.checked ? 'block' : 'none';
  
  if (!this.checked) {
    // Boyutları devre dışı bırak
    document.getElementById('sizePriceFields').style.display = 'none';
    document.getElementById('sizeIngredientSections').style.display = 'none';
    // Tüm boyut checkbox'larını temizle
    ['Small', 'Medium', 'Large'].forEach(size => {
      document.getElementById(`size${size}`).checked = false;
      document.getElementById(`${size.toLowerCase()}IngredientsSection`).style.display = 'none';
      document.getElementById(`price${size}`).value = '';
    });
  }
});


// Boyut seçimine göre fiyat alanlarını göster/gizle
['Small', 'Medium', 'Large'].forEach(size => {
  document.getElementById(`size${size}`).addEventListener('change', function() {
    const priceField = document.getElementById(`${size.toLowerCase()}PriceField`);
    const ingredientSection = document.getElementById(`${size.toLowerCase()}IngredientsSection`);
    
    if (this.checked) {
      priceField.style.display = 'block';
      ingredientSection.style.display = 'block';
      document.getElementById('sizePriceFields').style.display = 'block';
      document.getElementById('sizeIngredientSections').style.display = 'block';
    } else {
      priceField.style.display = 'none';
      ingredientSection.style.display = 'none';
      document.getElementById(`price${size}`).value = '';
      
      // Tüm boyutlar kapatıldıysa bölümleri gizle
      if (!document.getElementById('sizeSmall').checked && 
          !document.getElementById('sizeMedium').checked && 
          !document.getElementById('sizeLarge').checked) {
        document.getElementById('sizePriceFields').style.display = 'none';
        document.getElementById('sizeIngredientSections').style.display = 'none';
      }
    }
  });
});

// Boyutlara özel içerik ekleme fonksiyonları
function addSmallIngredientField() {
  addIngredientFieldTo('smallIngredientList');
}

function addMediumIngredientField() {
  addIngredientFieldTo('mediumIngredientList');
}

function addLargeIngredientField() {
  addIngredientFieldTo('largeIngredientList');
}


function addIngredientFieldTo(containerId) {
  const container = document.getElementById(containerId);
  const row = document.createElement("div");
  row.className = "ingredient-row";
  
  const select = document.createElement("select");
  select.innerHTML = '<option value="">-- İçerik seçin --</option>';
  allIngredients.forEach(ing => {
    select.innerHTML += `<option value="${ing.name}">${ing.name} (${ing.unit || 'adet'})</option>`;
  });
  
  const input = document.createElement("input");
  input.type = "number";
  input.placeholder = "Miktar";
  input.min = "0";
  input.step = "1";
  
  const delBtn = document.createElement("button");
  delBtn.className = "btn-danger";
  delBtn.innerHTML = '<i class="fas fa-times"></i>';
  delBtn.onclick = () => row.remove();
  
  row.append(select, input, delBtn);
  container.appendChild(row);
}






async function loadCariExpenses() {
  try {
    const querySnapshot = await db.collection(EXPENSES_COLLECTION)
      .where("type", "==", "stock")
      .where("payableAmount", ">", 0)
      .orderBy("payableAmount", "desc") // Önce ödenecek tutara göre sırala
      .orderBy("date", "desc") // Sonra tarihe göre sırala
      .get();

    updateCariTable(querySnapshot);
  } catch (error) {
    console.error("Cari giderleri yüklenirken hata:", error);
    const tbody = document.querySelector("#cariTable tbody");
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:red;">Hata: ${error.message}</td></tr>`;
  }
}

function updateCariTable(snapshot) {
  const tbody = document.querySelector("#cariTable tbody");
  if (snapshot.empty) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Cari gideri bulunamadı</td></tr>`;
    return;
  }

  let tbodyContent = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    const date = formatFirestoreDate(data.date);
    const taxAmount = (data.total * data.taxRate) / 100;

    tbodyContent += `
      <tr>
        <td>${data.invoiceName}</td>
        <td>${data.description}</td>
        <td>${data.unitPrice.toFixed(2)}</td>
        <td>${data.quantity}</td>
        <td>${data.total.toFixed(2)}</td>
        <td>${taxAmount.toFixed(2)}</td>
        <td>${data.totalWithTax.toFixed(2)}</td>
        <td class="payable-cell">${data.payableAmount.toFixed(2)}</td>
        <td>${date}</td>
      </tr>
    `;
  });

  tbody.innerHTML = tbodyContent;
}








    // STOK YÖNETİMİ FONKSİYONLARI
    async function loadStocks() {
      try {
        const querySnapshot = await db.collection("stocks").get();
        updateStokTablosu(querySnapshot);
        updateStockDropdowns(querySnapshot);
      } catch (error) {
        console.error("Stok yüklenirken hata:", error);
        showMessage('urunEkleMessage', "Stok yüklenirken hata: " + error.message, 'error');
      }
    }

    function updateStokTablosu(snapshot) {
      const tbody = document.querySelector("#stokTablosu tbody");
      
      if (!snapshot || snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Stok bulunamadı</td></tr>`;
        return;
      }
      
      let tbodyContent = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const quantity = data.quantity || 0;
        const name = data.name || "İsimsiz Ürün";
        const unit = data.unit || "ml";
        const status = quantity < 100 ? "Düşük" : "Normal";
        const statusClass = quantity < 100 ? "status-low" : "status-ok";
        
        tbodyContent += `
          <tr>
            <td>${name}</td>
            <td>${quantity} ${unit}</td>
            <td>${unit}</td>
            <td><span class="${statusClass}">${status}</span></td>
          </tr>
        `;
      });
      
      tbody.innerHTML = tbodyContent;
    }
    
    function updateStockDropdowns(snapshot) {
      const select1 = document.getElementById("guncelleSec");
      const select2 = document.getElementById("stokGecmisiSec");
      
      let content = "<option value=''>-- Ürün seçin --</option>";
      snapshot.forEach(doc => {
        const data = doc.data();
        content += `<option value="${doc.id}">${data.name}</option>`;
      });
      
      select1.innerHTML = content;
      select2.innerHTML = content;
    }

    async function urunEkle() {
      const name = document.getElementById("urunAdi").value.trim();
      const stock = parseInt(document.getElementById("urunStok").value);
      const unit = document.getElementById("urunBirim").value;
      const messageDiv = document.getElementById("urunEkleMessage");

      if (!name) {
        showMessage(messageDiv, "Ürün adı boş olamaz", 'error');
        return;
      }
      if (isNaN(stock) || stock < 0) {
        showMessage(messageDiv, "Geçerli bir stok miktarı girin", 'error');
        return;
      }

      try {
        // Mevcut ürünü kontrol et
        const q = db.collection("stocks").where("name", "==", name);
        const querySnapshot = await q.get();
        
        if (!querySnapshot.empty) {
          showMessage(messageDiv, "Bu ürün zaten mevcut", 'error');
          return;
        }

        await db.collection("stocks").add({
          name: name,
          quantity: stock,
          unit: unit,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Formu temizle ve mesaj göster
        document.getElementById("urunAdi").value = "";
        document.getElementById("urunStok").value = "";
        showMessage(messageDiv, "✔️ Ürün başarıyla eklendi", 'success');
        
        // Stokları yeniden yükle
        await loadStocks();
      } catch (err) {
        console.error("Ürün ekleme hatası:", err);
        showMessage(messageDiv, "❌ Hata: " + err.message, 'error');
      }
    }

    async function stokEkle() {
      const urunId = document.getElementById("guncelleSec").value;
      const addedAmount = parseInt(document.getElementById("eklenenStok").value);
      const messageDiv = document.getElementById("stokEkleMessage");

      // Validasyon
      if (!urunId) {
        showMessage(messageDiv, "Lütfen bir ürün seçin", 'error');
        return;
      }
      if (isNaN(addedAmount)) {
        showMessage(messageDiv, "Geçerli bir miktar girin", 'error');
        return;
      }
      if (addedAmount <= 0) {
        showMessage(messageDiv, "Miktar pozitif olmalı", 'error');
        return;
      }

      try {
        const ref = db.collection("stocks").doc(urunId);
        const docSnap = await ref.get();
        
        if (docSnap.exists) {
          const currentStock = docSnap.data().quantity || 0;
          const newStock = currentStock + addedAmount;
          
          await ref.update({ 
            quantity: newStock,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Stok geçmişine ekle
          const stockHistoryData = {
            stockId: urunId,
            productName: docSnap.data().name || "Bilinmiyor",
            amount: addedAmount,
            operation: 'ekleme',
            date: firebase.firestore.FieldValue.serverTimestamp(),
            userId: currentUser?.uid || "bilinmiyor",
            userName: currentUser?.email || "bilinmiyor",
            unit: docSnap.data().unit || "adet"
          };

          await db.collection("stock_history").add(stockHistoryData);

          // Formu temizle
          document.getElementById("eklenenStok").value = "";
          
          showMessage(messageDiv, "✔️ Stok başarıyla eklendi", 'success');
          
          // Stok tablolarını yeniden yükle
          await loadStocks();
          
          // Eğer stok geçmişi sekmesinde bu ürün seçili ise, geçmişi de yenile
          const selectedProductId = document.getElementById("stokGecmisiSec").value;
          if (selectedProductId === urunId) {
            await loadProductStockHistory(urunId);
          }
        } else {
          showMessage(messageDiv, "Ürün bulunamadı", 'error');
        }
      } catch (err) {
        showMessage(messageDiv, "❌ Hata: " + err.message, 'error');
        console.error("Stok ekleme hatası:", err);
      }
    }

    // Ürün yönetimi fonksiyonları
    async function loadProducts() {
      try {
        const querySnapshot = await db.collection("products").get();
        updateProductTable(querySnapshot);
        allProducts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        showMessage('productMessage', "Ürünler yüklenirken hata: " + error.message, 'error');
      }
    }

    function updateProductTable(snapshot) {
  const tbody = document.querySelector("#productTable tbody");
  allProducts = [];
  
  if (snapshot.empty) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Ürün bulunamadı</td></tr>`;
    return;
  }
  
  let tbodyContent = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    allProducts.push({ id: doc.id, ...data });
    
    const categoryName = allCategories.find(cat => cat.slug === data.category)?.name || data.category;
    
    // Fiyat/boyut bilgisi
    let priceInfo = data.hasSizes ? 
      Object.entries(data.sizes).map(([size, info]) => 
        `${size}: ${info.price.toFixed(2)}₺`
      ).join('<br>') : 
      `${data.price.toFixed(2)}₺`;
    
    tbodyContent += `
      <tr>
        <td>${data.name}</td>
        <td>${priceInfo}</td>
        <td>${categoryName}</td>
        <td class="action-cell">
          <button class="btn-danger action-btn" onclick="deleteProduct('${doc.id}')">
            <i class="fas fa-trash"></i> Sil
          </button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = tbodyContent;
}
    async function loadIngredients() {
  try {
    const querySnapshot = await db.collection("stocks").get();
    allIngredients = querySnapshot.docs.map(doc => ({
      id: doc.id,
      name: doc.data().name,
      unit: doc.data().unit || "adet" // Varsayılan birim ataması yapın
    }));
  } catch (error) {
    console.error("İçerikler yüklenirken hata:", error);
    showMessage('productMessage', "İçerikler yüklenirken hata: " + error.message, 'error');
  }
}

    function addIngredientField() {
  const container = document.getElementById("ingredientList");
  
  const row = document.createElement("div");
  row.className = "ingredient-row";
  
  // Ürün seçimi
  const select = document.createElement("select");
  select.innerHTML = '<option value="">-- İçerik seçin --</option>';
  
  allIngredients.forEach(ing => {
    // Birim bilgisi yoksa varsayılan olarak "adet" kullan
    const unit = ing.unit || "adet";
    select.innerHTML += `<option value="${ing.name}">${ing.name} (${unit})</option>`;
  });
  
  // Miktar girişi
  const input = document.createElement("input");
  input.type = "number";
  input.placeholder = "Miktar";
  input.min = "0";
  input.step = "1";
  
  // Sil butonu
  const delBtn = document.createElement("button");
  delBtn.className = "btn-danger";
  delBtn.innerHTML = '<i class="fas fa-times"></i>';
  delBtn.onclick = () => row.remove();
  
  row.append(select, input, delBtn);
  container.appendChild(row);
}

    async function saveNewProduct() {
  const name = document.getElementById("newProductName").value.trim();
  const price = parseFloat(document.getElementById("newProductPrice").value);
  const category = document.getElementById("newProductCategory").value;
  const messageDiv = document.getElementById("productMessage");
  const hasSizes = document.getElementById("enableSizes").checked;
  
  // Validasyon
  if (!name) {
    showMessage(messageDiv, "Ürün adı boş olamaz", 'error');
    return;
  }
  if (!category) {
    showMessage(messageDiv, "Kategori seçmelisiniz", 'error');
    return;
  }

  try {
    // Kategori bilgisini al (slug ile birlikte)
    const categoryQuery = await db.collection("categories").where("slug", "==", category).get();
    if (categoryQuery.empty) {
      showMessage(messageDiv, "Geçersiz kategori", 'error');
      return;
    }
    
    const categoryDoc = categoryQuery.docs[0];
    const categoryData = categoryDoc.data();

    // Standart içerikleri topla
    const ingredients = {};
    let hasError = false;
    
    document.querySelectorAll("#ingredientList .ingredient-row").forEach(row => {
      const ingName = row.querySelector("select").value;
      const amount = parseFloat(row.querySelector("input").value);
      
      if (!ingName) {
        showMessage(messageDiv, "Lütfen tüm içerikleri seçin", 'error');
        hasError = true;
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        showMessage(messageDiv, "Lütfen geçerli miktar girin", 'error');
        hasError = true;
        return;
      }
      
      ingredients[ingName] = amount;
    });
    
    if (hasError) return;

    // Boyut bilgilerini topla
    const sizes = {};
    if (hasSizes) {
      // Küçük boy
      if (document.getElementById("sizeSmall").checked) {
        const smallPrice = parseFloat(document.getElementById("priceSmall").value);
        if (isNaN(smallPrice) || smallPrice <= 0) {
          showMessage(messageDiv, "Küçük boy için geçerli fiyat girin", 'error');
          return;
        }
        
        const smallIngredients = {};
        document.querySelectorAll("#smallIngredientList .ingredient-row").forEach(row => {
          const ingName = row.querySelector("select").value;
          const amount = parseFloat(row.querySelector("input").value);
          smallIngredients[ingName] = amount;
        });
        
        sizes.küçük = {
          price: smallPrice,
          ingredients: smallIngredients
        };
      }
      
      // Orta boy
      if (document.getElementById("sizeMedium").checked) {
        const mediumPrice = parseFloat(document.getElementById("priceMedium").value);
        if (isNaN(mediumPrice) || mediumPrice <= 0) {
          showMessage(messageDiv, "Orta boy için geçerli fiyat girin", 'error');
          return;
        }
        
        const mediumIngredients = {};
        document.querySelectorAll("#mediumIngredientList .ingredient-row").forEach(row => {
          const ingName = row.querySelector("select").value;
          const amount = parseFloat(row.querySelector("input").value);
          mediumIngredients[ingName] = amount;
        });
        
        sizes.orta = {
          price: mediumPrice,
          ingredients: mediumIngredients
        };
      }
      
      // Büyük boy
      if (document.getElementById("sizeLarge").checked) {
        const largePrice = parseFloat(document.getElementById("priceLarge").value);
        if (isNaN(largePrice) || largePrice <= 0) {
          showMessage(messageDiv, "Büyük boy için geçerli fiyat girin", 'error');
          return;
        }
        
        const largeIngredients = {};
        document.querySelectorAll("#largeIngredientList .ingredient-row").forEach(row => {
          const ingName = row.querySelector("select").value;
          const amount = parseFloat(row.querySelector("input").value);
          largeIngredients[ingName] = amount;
        });
        
        sizes.büyük = {
          price: largePrice,
          ingredients: largeIngredients
        };
      }
      
      // En az bir boyut seçilmiş mi kontrolü
      if (Object.keys(sizes).length === 0) {
        showMessage(messageDiv, "En az bir boyut seçmelisiniz", 'error');
        return;
      }
    } else {
      // Boyutsuz ürün için fiyat kontrolü
      if (isNaN(price) || price <= 0) {
        showMessage(messageDiv, "Geçerli bir fiyat girin", 'error');
        return;
      }
      
      // En az bir içerik kontrolü
      if (Object.keys(ingredients).length === 0) {
        showMessage(messageDiv, "En az bir içerik eklemelisiniz", 'error');
        return;
      }
    }

    // Mevcut ürün sayısını al (order için)
    const snapshot = await db.collection("products").get();
    const productCount = snapshot.size;

    const productData = {
      name: name,
      category: categoryData.name, // Kategori adını kaydediyoruz
      categorySlug: category,
      order: productCount,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Boyutlu ürün mü?
    if (hasSizes && Object.keys(sizes).length > 0) {
      productData.sizes = sizes;
      productData.hasSizes = true;
      // Boyutlu ürünler için temel fiyatı ilk boyuttan al
      productData.price = Object.values(sizes)[0].price;
    } else {
      // Standart ürün
      productData.price = price;
      productData.ingredients = ingredients;
      productData.hasSizes = false;
    }

    // Firestore'a kaydet
    const docRef = await db.collection("products").add(productData);
    console.log("Ürün başarıyla eklendi, ID:", docRef.id);

    // Formu temizle
    document.getElementById("newProductName").value = "";
    document.getElementById("newProductPrice").value = "";
    document.getElementById("ingredientList").innerHTML = "";
    document.getElementById("enableSizes").checked = false;
    document.getElementById("sizeOptions").style.display = "none";
    document.getElementById("sizePriceFields").style.display = "none";
    document.getElementById("sizeIngredientSections").style.display = "none";
    
    showMessage(messageDiv, "✔️ Ürün başarıyla eklendi", 'success');
    await loadProducts();
  } catch (err) {
    console.error("Ürün ekleme hatası:", err);
    showMessage(messageDiv, "❌ Hata: " + err.message, 'error');
  }
}



    async function deleteProduct(productId) {
      if (!confirm("Bu ürünü silmek istediğinize emin misiniz? Bu işlem geri alınamaz.")) return;

      const messageDiv = document.getElementById('productMessage');
      
      try {
        // Önce bu ürünün kullanıldığı sipariş var mı kontrol et
        const ordersRef = db.collection("sales").where("products", "array-contains", productId);
        const ordersSnapshot = await ordersRef.get();
        
        if (!ordersSnapshot.empty) {
          showMessage(messageDiv, "Bu ürünü içeren siparişler var. Önce siparişleri silmelisiniz.", 'error');
          return;
        }
        
        // Ürünü sil
        await db.collection("products").doc(productId).delete();
        showMessage(messageDiv, "✔️ Ürün başarıyla silindi", 'success');
        await loadProducts();
      } catch (err) {
        showMessage(messageDiv, "❌ Hata: " + err.message, 'error');
        console.error("Ürün silme hatası:", err);
      }
    }

    // Kullanıcı yönetimi
    async function loadUsers() {
      try {
        const querySnapshot = await db.collection("users").get();
        updateUserTable(querySnapshot);
      } catch (error) {
        console.error("Kullanıcılar yüklenirken hata:", error);
        showMessage('userMessage', "Kullanıcılar yüklenirken hata: " + error.message, 'error');
      }
    }

    function updateUserTable(snapshot) {
      const tbody = document.querySelector("#userTable tbody");
      
      if (snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Kullanıcı bulunamadı</td></tr>`;
        return;
      }
      
      let tbodyContent = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        tbodyContent += `
          <tr>
            <td>${data.email}</td>
            <td>${data.role}</td>
            <td class="action-cell">
              <button class="btn-danger action-btn" onclick="deleteUser('${doc.id}')">
                <i class="fas fa-trash"></i> Sil
              </button>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = tbodyContent;
    }


      // Sipariş iptal fonksiyonu
    async function cancelSelectedOrder() {
  const selectedOrderRadio = document.querySelector('input[name="selectedOrder"]:checked');
  if (!selectedOrderRadio) {
    alert("Lütfen iptal etmek için bir sipariş seçin.");
    return;
  }

  const orderId = selectedOrderRadio.value;
  if (!confirm("Bu siparişi iptal etmek istediğinize emin misiniz?")) {
    return;
  }

  try {
    // Siparişi iptal et olarak işaretle
    await db.collection("sales").doc(orderId).update({
      canceled: true,
      canceledAt: firebase.firestore.FieldValue.serverTimestamp(),
      canceledBy: currentUser.email
    });

    alert("Sipariş başarıyla iptal edildi.");
    await loadOrderHistory();
  } catch (error) {
    console.error("İptal işlemi sırasında hata:", error);
    alert("İptal işlemi başarısız: " + error.message);
  }
}













    async function deleteUser(userId) {
      if (!confirm("Bu kullanıcıyı silmek istediğinize emin misiniz?")) return;
      
      try {
        await db.collection("users").doc(userId).delete();
        showMessage('userMessage', "✔️ Kullanıcı başarıyla silindi", 'success');
        await loadUsers();
      } catch (err) {
        showMessage('userMessage', "❌ Hata: " + err.message, 'error');
      }
    }

    // Kategori yönetimi
    async function loadCategories() {
  try {
    // Sıralı şekilde kategorileri çek - DÜZELTİLDİ
    const querySnapshot = await db.collection("categories")
      .orderBy("order")
      .get();
    
    const allCats = [];
    querySnapshot.forEach(doc => {
      allCats.push({ id: doc.id, ...doc.data() });
    });

    // Ana kategorileri bul (parent'ı olmayanlar)
    const mainCategories = allCats.filter(cat => !cat.parent);
    
    // Her ana kategori için alt kategorileri ata
    mainCategories.forEach(mainCat => {
      mainCat.subcategories = allCats.filter(subCat => 
        subCat.parent === mainCat.id
      );
    });

    // Kategori ağacını render et
    renderCategoryTree(mainCategories);
    
    // Kategori dropdown'larını güncelle
    updateCategoryDropdowns(mainCategories);

  } catch (error) {
    console.error("Kategoriler yüklenirken hata:", error);
    showMessage('categoryMessage', "Kategoriler yüklenirken hata: " + error.message, 'error');
  }
}

    // Kategori ağacını görselleştirme
    function renderCategoryTree(categories) {
  const container = document.getElementById("categoryList");
  container.innerHTML = '';

  if (!categories || categories.length === 0) {
    container.innerHTML = "<p>Kategori bulunamadı</p>";
    return;
  }

  // Sıralama yap
  categories.sort((a, b) => (a.order || 0) - (b.order || 0));

  categories.forEach(category => {
    const li = document.createElement('li');
    li.setAttribute('data-id', category.id);
    li.className = 'sortable-item';
    
    li.innerHTML = `
      <div class="category-item">
        <strong>${category.name}</strong>
        <span style="float:right; color:#666">${category.slug}</span>
        <button class="btn-danger" onclick="deleteCategory('${category.id}', '${category.name}')" 
                style="margin-left: 10px; padding: 5px 8px; font-size: 12px;">
          <i class="fas fa-trash"></i> Sil
        </button>
      </div>
    `;

    // Alt kategoriler
    if (category.subcategories && category.subcategories.length > 0) {
      const subUl = document.createElement('ul');
      subUl.style.paddingLeft = '20px';
      
      category.subcategories.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach(subCat => {
        const subLi = document.createElement('li');
        subLi.setAttribute('data-id', subCat.id);
        subLi.className = 'sortable-item';
        
        subLi.innerHTML = `
          <div class="subcategory-item">
            → ${subCat.name}
            <span style="float:right; color:#666">${subCat.slug}</span>
            <button class="btn-danger" onclick="deleteCategory('${subCat.id}', '${subCat.name}')" 
                    style="margin-left: 10px; padding: 5px 8px; font-size: 12px;">
              <i class="fas fa-trash"></i> Sil
            </button>
          </div>
        `;
        subUl.appendChild(subLi);
      });
      li.appendChild(subUl);
    }

    container.appendChild(li);
  });
}


// Mevcut kategorilere order alanı ekle (bir kerelik çalıştırılacak)
async function addOrderFieldToCategories() {
  const snapshot = await db.collection("categories").get();
  const batch = db.batch();
  
  snapshot.docs.forEach((doc, index) => {
    batch.update(doc.ref, { order: index });
  });
  
  await batch.commit();
  console.log("Order alanları eklendi");
}

    // Kategori dropdown'larını güncelleme
    function updateCategoryDropdowns(mainCategories) {
  const productCategorySelect = document.getElementById("newProductCategory");
  productCategorySelect.innerHTML = '<option value="">-- Kategori seçin --</option>';
  
  mainCategories.forEach(category => {
    // Ana kategori
    productCategorySelect.innerHTML += `<option value="${category.slug}">${category.name}</option>`;
    
    // Alt kategoriler (varsa)
    if (category.subcategories && category.subcategories.length > 0) {
      category.subcategories.forEach(subCat => {
        productCategorySelect.innerHTML += `<option value="${subCat.slug}">${category.name} → ${subCat.name}</option>`;
      });
    }
  });

  // Modal için ana kategori seçeneklerini güncelle
  const parentCategorySelect = document.getElementById("parentCategorySelect");
  parentCategorySelect.innerHTML = '<option value="">-- Üst kategori seçin --</option>';
  mainCategories.forEach(category => {
    parentCategorySelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
  });
}

    // Kategori türü seçimine göre üst kategori seçimini göster/gizle
    function toggleParentSelect() {
      const isMain = document.querySelector('input[name="categoryType"]:checked').value === 'main';
      document.getElementById('parentCategoryGroup').style.display = isMain ? 'none' : 'block';
    }

    // Kategori kaydetme fonksiyonu
    async function saveCategory() {
  const name = document.getElementById('modalCategoryName').value.trim();
  const isMain = document.querySelector('input[name="categoryType"]:checked').value === 'main';
  const parentId = isMain ? null : document.getElementById('parentCategorySelect').value;
  const messageDiv = document.getElementById('modalCategoryMessage');
  
  if(!name) {
      showMessage(messageDiv, "Kategori adı boş olamaz", 'error');
      return;
  }

  try {
      // Slug oluştur (Türkçe karakterleri düzelt)
      const slug = name.toLowerCase()
          .replace(/ /g, '_')
          .replace(/[ğ]/g, 'g')
          .replace(/[ü]/g, 'u')
          .replace(/[ş]/g, 's')
          .replace(/[ı]/g, 'i')
          .replace(/[ö]/g, 'o')
          .replace(/[ç]/g, 'c');

      // Mevcut kategori sayısını al (order için) - DÜZELTİLDİ
      const snapshot = await db.collection("categories").get();
      const categoryCount = snapshot.size;

      const categoryData = {
          name: name,
          slug: slug,
          order: categoryCount, // Yeni eklenen kategori en sona gelsin
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if(!isMain) {
          if(!parentId) {
              showMessage(messageDiv, "Alt kategori için üst kategori seçmelisiniz", 'error');
              return;
          }
          categoryData.parent = parentId;
          
          // Üst kategorinin bilgilerini al
          const parentCategory = await db.collection("categories").doc(parentId).get();
          if (parentCategory.exists) {
              categoryData.parentSlug = parentCategory.data().slug;
          }
      }

      // Kategoriyi ekle
      await db.collection("categories").add(categoryData);
      
      showMessage(messageDiv, "✔️ Kategori başarıyla eklendi", 'success');
      
      // Modalı kapat ve kategorileri yenile
      closeModal('categoryModal');
      document.getElementById('modalCategoryName').value = '';
      await loadCategories();
      
      // 2 saniye sonra mesajı gizle
      setTimeout(() => {
          messageDiv.style.display = 'none';
      }, 2000);
  } catch(err) {
      console.error("Kategori ekleme hatası:", err);
      showMessage(messageDiv, "❌ Hata: " + err.message, 'error');
  }
}

    async function deleteCategory(categoryId, categoryName) {
  if (!confirm(`"${categoryName}" kategorisini silmek istediğinize emin misiniz?`)) return;
  
  // Mesaj div'ini bul (sayfadaki herhangi bir message div'i kullanılabilir)
  const messageDiv = document.getElementById('productMessage') || document.createElement('div');
  
  try {
    // 1. Bu kategoride ürün var mı kontrol et
    const productsInCategory = await db.collection("products")
      .where("category", "==", categoryName)
      .limit(1)
      .get();
    
    if (!productsInCategory.empty) {
      showMessage(messageDiv, "Bu kategoride ürünler var, önce onları silmelisiniz", 'error');
      return;
    }
    
    // 2. Alt kategorileri kontrol et
    const subCategories = await db.collection("categories")
      .where("parent", "==", categoryId)
      .limit(1)
      .get();
    
    if (!subCategories.empty) {
      showMessage(messageDiv, "Bu kategorinin alt kategorileri var, önce onları silmelisiniz", 'error');
      return;
    }
    
    // 3. Kategoriyi sil
    await db.collection("categories").doc(categoryId).delete();
    
    showMessage(messageDiv, "✔️ Kategori başarıyla silindi", 'success');
    
    // Kategorileri yenile
    await loadCategories();
    
    // 2 saniye sonra mesajı gizle
    setTimeout(() => {
      if (messageDiv.style) messageDiv.style.display = 'none';
    }, 2000);
  } catch (err) {
    console.error("Kategori silme hatası:", err);
    showMessage(messageDiv, "❌ Hata: " + err.message, 'error');
    
    // Hata mesajını da 5 saniye sonra gizle
    setTimeout(() => {
      if (messageDiv.style) messageDiv.style.display = 'none';
    }, 5000);
  }
}

    // Stok geçmişi
    async function loadProductStockHistory(productId) {
      try {
        const q = db.collection("stock_history")
          .where("stockId", "==", productId)
          .orderBy("date", "desc");
        
        const querySnapshot = await q.get();
        updateStockHistoryTable(querySnapshot);
      } catch (error) {
        console.error("Ürün stok geçmişi yüklenirken hata:", error);
      }
    }

    function updateStockHistoryTable(snapshot) {
      const tbody = document.querySelector("#stokGecmisiTablosu tbody");
      
      if (!snapshot || snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Stok geçmişi bulunamadı</td></tr>`;
        return;
      }
      
      let tbodyContent = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const date = formatFirestoreDate(data.date);
        const operation = data.operation === 'ekleme' ? 
          `<span style="color:green">+${data.amount} ${data.unit || ''}</span>` : 
          `<span style="color:red">-${data.amount} ${data.unit || ''}</span>`;
        
        tbodyContent += `
          <tr>
            <td>${date}</td>
            <td>${operation}</td>
            <td>${data.amount} ${data.unit || ''}</td>
            <td>${data.userName || data.userId}</td>
          </tr>
        `;
      });
      
      tbody.innerHTML = tbodyContent;
    }

    // Dashboard verileri
    async function loadDashboardData() {
      try {
        // Son siparişleri yükle
        const ordersQuery = db.collection("sales")
          .orderBy("timestamp", "desc")
          .limit(5);
        
        const ordersSnapshot = await ordersQuery.get();
        updateRecentOrders(ordersSnapshot);
        
        // Stok işlem geçmişi
        const stockHistoryQuery = db.collection("stock_history")
          .orderBy("date", "desc")
          .limit(10);
        
        const stockHistorySnapshot = await stockHistoryQuery.get();
        updateStockOperationsHistory(stockHistorySnapshot);
      } catch (error) {
        console.error("Dashboard verileri yüklenirken hata:", error);
      }
    }

    async function updateRecentOrders(snapshot) {
      const tbody = document.querySelector("#sonSiparisler tbody");

      if (!snapshot || snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Son sipariş bulunamadı</td></tr>`;
        return;
      }

      let tbodyContent = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const date = formatFirestoreDate(data.timestamp);
        const customer = data.user || "Müşteri Bilgisi Yok";
        const total = data.total || 0;
        const isCanceled = data.canceled || false;

        // Satır stilini belirle
        const rowClass = isCanceled ? "canceled-row" : "";

        tbodyContent += `
          <tr class="${rowClass}">
            <td>${customer} ${isCanceled ? '<span class="status-canceled">(İptal)</span>' : ''}</td>
            <td>${total}₺</td>
            <td>${date}</td>
          </tr>
        `;
      });

      tbody.innerHTML = tbodyContent;
    }

    // Sipariş geçmişi yükleme
    async function loadOrderHistory() {
      try {
        const ordersQuery = db.collection("sales")
          .orderBy("timestamp", "desc")
          .limit(20); 
        
        const ordersSnapshot = await ordersQuery.get();
        updateOrderHistoryTable(ordersSnapshot);
      } catch (error) {
        console.error("Sipariş geçmişi yüklenirken hata:", error);
        const tbody = document.querySelector("#siparisTablosu tbody");
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red;">Hata: ${error.message}</td></tr>`;
      }
    }

    async function updateOrderHistoryTable(snapshot) {
      const tbody = document.querySelector("#siparisTablosu tbody");

      if (!snapshot || snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Sipariş bulunamadı</td></tr>`;
        return;
      }

      let tbodyContent = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const date = formatFirestoreDate(data.timestamp);
        const customer = data.user || "Müşteri Bilgisi Yok";
        const total = data.total || 0;
        const isCanceled = data.canceled || false;

        // Ürün bilgilerini items dizisinden çek
        let productInfo = "Ürün bilgisi bulunamadı";
        if (Array.isArray(data.items)) {
          productInfo = data.items.map(item => {
            const name = item.product || "Ürün";
            const qty = item.qty || 1;
            return `${qty}x ${name}`;
          }).join(", ");
        }

        // Satır stilini belirle
        const rowClass = isCanceled ? "canceled-row" : "";

        tbodyContent += `
          <tr class="${rowClass}">
            <td><input type="radio" name="selectedOrder" value="${doc.id}"></td>
            <td>${customer}</td>
            <td>${productInfo}</td>
            <td>${total}₺</td>
            <td>${date}</td>
            <td>
              ${isCanceled ? '<span class="status-canceled">İptal</span>' : 'Aktif'}
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = tbodyContent;
    }

    function updateStockOperationsHistory(snapshot) {
      const tbody = document.querySelector("#stokIslemleri tbody");
      
      if (!snapshot || snapshot.empty) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Stok işlemi bulunamadı</td></tr>`;
        return;
      }
      
      let tbodyContent = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const date = formatFirestoreDate(data.date);
        const product = data.productName || "Ürün Bilgisi Yok";
        const amount = data.amount || 0;
        const operation = data.operation || "İşlem Bilgisi Yok";

        tbodyContent += `
          <tr>
            <td><input type="radio" name="selectedStockHistory" value="${doc.id}"></td>
            <td>${date}</td>
            <td>${product}</td>
            <td>${amount} ${data.unit || ''}</td>
            <td>${operation}</td>
          </tr>
        `;
      });
      
      tbody.innerHTML = tbodyContent;
    }

    // İade/Değişim
    function openRefundModal() {
      document.getElementById('refundModal').style.display = 'flex';
    }

    function processRefund() {
      alert("İade işlemi başarıyla tamamlandı");
      closeModal('refundModal');
    }



      const EXPENSES_COLLECTION = "expenses";

// Modal açma fonksiyonu
function openAddStockExpenseModal() {
  document.getElementById('expenseInvoiceName').value = '';
  document.getElementById('expenseDescription').value = '';
  document.getElementById('expenseUnitPrice').value = '';
  document.getElementById('expenseQuantity').value = '';
  document.getElementById('expenseTaxRate').value = '18';
  document.getElementById('stockExpenseMessage').style.display = 'none';
  document.getElementById('stockExpenseModal').style.display = 'flex';
}



  // Stok giderini kaydet
async function saveStockExpense() {
  const invoiceName = document.getElementById('expenseInvoiceName').value.trim();
  const description = document.getElementById('expenseDescription').value.trim();
  const unitPrice = parseFloat(document.getElementById('expenseUnitPrice').value);
  const quantity = parseInt(document.getElementById('expenseQuantity').value);
  const taxRate = parseFloat(document.getElementById('expenseTaxRate').value);
  const messageDiv = document.getElementById('stockExpenseMessage');
  const paid = parseFloat(document.getElementById('expensePaid').value) || 0;
  const payable = parseFloat(document.getElementById('expensePayable').value) || 0;


  // Validasyon
  if (!invoiceName) {
    showMessage(messageDiv, "Fatura adı boş olamaz", 'error');
    return;
  }
  if (isNaN(unitPrice)) {
    showMessage(messageDiv, "Geçerli bir birim fiyat girin", 'error');
    return;
  }
  if (isNaN(quantity) || quantity < 1) {
    showMessage(messageDiv, "Geçerli bir adet girin", 'error');
    return;
  }
  if (isNaN(taxRate) || taxRate < 0 || taxRate > 100) {
    showMessage(messageDiv, "Geçerli bir KDV oranı girin (0-100 arası)", 'error');
    return;
  }

  // Hesaplamalar
  const total = unitPrice * quantity;
  const taxAmount = total * (taxRate / 100);
  const totalWithTax = total + taxAmount;

  try {
    // Firestore'a kaydet
    await db.collection(EXPENSES_COLLECTION).add({
      type: "stock",
      invoiceName: invoiceName,
      description: description,
      unitPrice: unitPrice,
      quantity: quantity,
      taxRate: taxRate,
      total: total,
      totalWithTax: totalWithTax,
      paidAmount: paid,
      payableAmount: payable,
      date: firebase.firestore.FieldValue.serverTimestamp()
    });

    showMessage(messageDiv, "✔️ Stok gideri başarıyla eklendi", 'success');
    closeModal('stockExpenseModal');
    await loadStockExpenses(); // Tabloyu güncelle
  } catch (err) {
    console.error("Stok gideri ekleme hatası:", err);
    showMessage(messageDiv, "❌ Hata: " + err.message, 'error');
  }
}



// Stok giderlerini yükle
async function loadStockExpenses() {
  try {
    const querySnapshot = await db.collection(EXPENSES_COLLECTION)
      .where("type", "==", "stock")
      .orderBy("date", "desc")
      .get();

    updateStockExpensesTable(querySnapshot);
  } catch (error) {
    console.error("Stok giderleri yüklenirken hata:", error);
    const tbody = document.querySelector("#stockExpensesTable tbody");
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:red;">Hata: ${error.message}</td></tr>`;
  }
}




// Tabloyu güncelle
function updateStockExpensesTable(snapshot) {
  const tbody = document.querySelector("#stockExpensesTable tbody");
  if (snapshot.empty) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Stok gideri bulunamadı</td></tr>`;
    return;
  }

  let tbodyContent = "";
  snapshot.forEach(doc => {
    const data = doc.data();
    const date = formatFirestoreDate(data.date);
    
    // KDV tutarını hesapla: (toplam fiyat * KDV oranı) / 100
    const taxAmount = (data.total * data.taxRate) / 100;

    tbodyContent += `
      <tr>
        <td>${data.invoiceName}</td>
        <td>${data.description}</td>
        <td>${data.unitPrice.toFixed(2)}</td>
        <td>${data.quantity}</td>
        <td>${data.total.toFixed(2)}</td>
        <td>${taxAmount.toFixed(2)}</td> <!-- KDV Tutarı (TL) -->
        <td>${data.totalWithTax.toFixed(2)}</td>
        <td>${date}</td>
        <td>
          <button class="btn-danger action-btn" onclick="deleteExpense('${doc.id}')">
            <i class="fas fa-trash"></i> Sil
          </button>
        </td>
      </tr>
    `;
  });

  tbody.innerHTML = tbodyContent;
}



// Gider silme
async function deleteExpense(expenseId) {
  if (!confirm("Bu gideri silmek istediğinize emin misiniz?")) return;
  try {
    await db.collection(EXPENSES_COLLECTION).doc(expenseId).delete();
    await loadStockExpenses();
  } catch (err) {
    console.error("Gider silme hatası:", err);
    alert("Gider silinemedi: " + err.message);
  }
}





  // Stok rapor modalını aç
function openStockReportModal() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('stockReportStartDate').value = today;
  document.getElementById('stockReportEndDate').value = today;
  document.getElementById('stockReportMessage').style.display = 'none';
  document.getElementById('stockReportModal').style.display = 'flex';
}

// Stok raporu oluştur
async function generateStockReport() {
  const startDate = document.getElementById('stockReportStartDate').value;
  const endDate = document.getElementById('stockReportEndDate').value;
  const messageDiv = document.getElementById('stockReportMessage');

  if (!startDate || !endDate) {
    showMessage(messageDiv, 'Lütfen tarih aralığı seçin', 'error');
    return;
  }

  showMessage(messageDiv, 'Rapor oluşturuluyor...', 'warning');

  try {
    const start = new Date(startDate);
    start.setHours(0, 0, 0, 0);
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999);

    const querySnapshot = await db.collection("stock_history")
      .where("date", ">=", start)
      .where("date", "<=", end)
      .orderBy("date", "desc")
      .get();

    if (querySnapshot.empty) {
      showMessage(messageDiv, 'Seçilen tarih aralığında stok işlemi bulunamadı', 'error');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Başlık
    doc.setFontSize(14);
    doc.text(`STOK GECMIS RAPORU (${startDate} - ${endDate})`, 105, 20, { align: 'center' });

    // Tablo verileri
    const reportData = querySnapshot.docs.map(doc => {
      const data = doc.data();
      return [
        formatFirestoreDate(data.date),
        data.productName,
        data.operation === 'ekleme' ? `+${data.amount}` : `-${data.amount}`,
        data.unit,
        data.userName
      ];
    });

    // Tablo oluştur
    doc.autoTable({
      startY: 30,
      head: [['Tarih', 'Ürün', 'Miktar', 'Birim', 'Kullanici']],
      body: reportData,
      styles: { font: "arial", fontSize: 8 },
      headStyles: { fontStyle: 'bold' }
    });

    // Toplam işlem sayısı
    doc.text(`Toplam Islem Sayisi: ${querySnapshot.size}`, 14, doc.lastAutoTable.finalY + 10);

    doc.save(`stok_gecmisi_${startDate}_${endDate}.pdf`);
    showMessage(messageDiv, '✔️ Rapor hazır!', 'success');
  } catch (error) {
    console.error("Rapor oluşturma hatası:", error);
    showMessage(messageDiv, '❌ Hata: ' + error.message, 'error');
  }
}


// Sipariş rapor modalını aç
function openOrderReportModal() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('orderReportStartDate').value = today;
  document.getElementById('orderReportEndDate').value = today;
  document.getElementById('orderReportMessage').style.display = 'none';
  document.getElementById('orderReportModal').style.display = 'flex';
}

// Sipariş raporu oluştur
async function generateOrderReport() {
  const startDate = document.getElementById('orderReportStartDate').value;
  const endDate = document.getElementById('orderReportEndDate').value;
  const messageDiv = document.getElementById('orderReportMessage');

  // Seçenekleri al
  const includeSales = document.getElementById('reportOptionSales').checked;
  const includeRevenue = document.getElementById('reportOptionRevenue').checked;
  const includeDetails = document.getElementById('reportOptionDetails').checked;

  if (!startDate || !endDate) {
    showMessage(messageDiv, 'Lütfen tarih aralığı seçin', 'error');
    return;
  }

  showMessage(messageDiv, 'Rapor oluşturuluyor...', 'warning');

  try {
    const start = new Date(startDate);
    start.setHours(0, 0, 0, 0);
    const end = new Date(endDate);
    end.setHours(23, 59, 59, 999);

    const querySnapshot = await db.collection("sales")
      .where("timestamp", ">=", start)
      .where("timestamp", "<=", end)
      .orderBy("timestamp", "desc")
      .get();

    if (querySnapshot.empty) {
      showMessage(messageDiv, 'Seçilen tarih aralığında sipariş bulunamadı', 'error');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Başlık
    doc.setFontSize(14);
    doc.text(`Siparis Raporu (${startDate} - ${endDate})`, 105, 20, { align: 'center' });

    let currentY = 30; // PDF'deki mevcut y pozisyonu
    let totalRevenue = 0;
    const allProductsSales = {}; // Tüm ürün satışları

    // Günlere göre gruplandırma
    const dailyData = {};
    
    querySnapshot.forEach(doc => {
      const data = doc.data();
      const dateStr = data.timestamp.toDate().toLocaleDateString('tr-TR');
      const total = data.total || 0;
      totalRevenue += total;

      if (!dailyData[dateStr]) {
        dailyData[dateStr] = {
          orders: [],
          revenue: 0,
          products: {} // Günlük ürün satışları
        };
      }
      
      dailyData[dateStr].orders.push(data);
      dailyData[dateStr].revenue += total;

      // Ürün satışlarını say
      if (data.items) {
        data.items.forEach(item => {
          const productName = item.product;
          const qty = item.qty || 1;
          
          // Günlük
          if (!dailyData[dateStr].products[productName]) {
            dailyData[dateStr].products[productName] = 0;
          }
          dailyData[dateStr].products[productName] += qty;
          
          // Toplam
          if (!allProductsSales[productName]) {
            allProductsSales[productName] = 0;
          }
          allProductsSales[productName] += qty;
        });
      }
    });

    // 1. Ürün Satış Adetleri Raporu
    if (includeSales) {
      doc.setFontSize(12);
      doc.setFont("courier", "bold");
      doc.text("ürün satis adetleri", 12, currentY);
      currentY += 10;

      // Günlük satışlar
      Object.entries(dailyData).forEach(([date, dayData]) => {
        doc.setFontSize(12);
        doc.text(`${date} tarihli ürün satislari`, 12, currentY);
        currentY += 8;

        // Ürünleri satış miktarına göre sırala (çoktan aza)
        const sortedProducts = Object.entries(dayData.products)
          .sort((a, b) => b[1] - a[1]);

        // Tablo verileri
        const tableData = sortedProducts.map(([product, qty]) => [product, `${qty} adet`]);

        doc.autoTable({
          startY: currentY,
          head: [['ürün adi', 'Adet']],
          body: tableData,
          styles: { font: "courier", fontSize: 9 },
          headStyles: { fontStyle: 'bold' }
        });

        currentY = doc.lastAutoTable.finalY + 5;
      });

      // Toplam satışlar
      doc.setFontSize(12);
      doc.text("toplam ürün satislari (belirtilen tarihler) ", 12, currentY);
      currentY += 8;

      // Tüm ürünleri satış miktarına göre sırala
      const sortedAllProducts = Object.entries(allProductsSales)
        .sort((a, b) => b[1] - a[1]);
      
      const totalTableData = sortedAllProducts.map(([product, qty]) => [product, `${qty} adet`]);

      doc.autoTable({
        startY: currentY,
        head: [['ürün adi', 'Toplam Adet']],
        body: totalTableData,
        styles: { font: "courier", fontSize: 10 },
        headStyles: { fontStyle: 'bold' }
      });

      currentY = doc.lastAutoTable.finalY + 10;
    }

    // 2. Ciro Raporu
    if (includeRevenue) {
      doc.setFontSize(12);
      doc.setFont("courier", "bold");
      doc.text("CIRO RAPORU", 12, currentY);
      currentY += 10;

      // Günlük ciro
      const revenueTableData = Object.entries(dailyData).map(([date, dayData]) => {
        return [date, `${dayData.revenue.toFixed(2)} TL`];
      });

      // Toplam ciro satırı
      revenueTableData.push(['TOPLAM', `${totalRevenue.toFixed(2)} TL`]);

      doc.autoTable({
        startY: currentY,
        head: [['Tarih', 'Ciro']],
        body: revenueTableData,
        styles: { font: "courier", fontSize: 10 },
        headStyles: { fontStyle: 'bold' },
        // Son satırı (toplam) kalın yap
        didDrawCell: function(data) {
          if (data.row.index === revenueTableData.length - 1) {
            doc.setFont("courier", "bold");
          }
        }
      });

      currentY = doc.lastAutoTable.finalY + 10;
    }

    // 3. Tüm Sipariş Detayı
    if (includeDetails) {
      doc.setFontSize(14);
      doc.setFont("courier", "bold");
      doc.text("tum siparis detayo", 10, currentY);
      currentY += 10;

      // Her gün için bir tablo oluştur
      Object.entries(dailyData).forEach(([date, dayData]) => {
        doc.setFontSize(10);
        doc.text(`${date} - Toplam Ciro: ${dayData.revenue.toFixed(2)} TL`, 14, currentY);
        currentY += 8;

        const tableData = dayData.orders.map(order => {
          const products = order.items?.map(item => `${item.qty}x ${item.product}`).join(', ') || '';
          return [
            order.user || 'Müşteri Yok',
            products,
            `${order.total.toFixed(2)}₺`,
            formatFirestoreDate(order.timestamp)
          ];
        });

        doc.autoTable({
          startY: currentY,
          head: [['Personel', 'Ürünler', 'Tutar', 'Tarih']],
          body: tableData,
          styles: { font: "courier", fontSize: 8 },
          headStyles: { fontStyle: 'bold' }
        });

        currentY = doc.lastAutoTable.finalY + 10;
      });
    }

    doc.save(`siparis_raporu_${startDate}_${endDate}.pdf`);
    showMessage(messageDiv, '✔️ Rapor hazır!', 'success');
  } catch (error) {
    console.error("Rapor oluşturma hatası:", error);
    showMessage(messageDiv, '❌ Hata: ' + error.message, 'error');
  }
}









    // Modal işlemleri
    function openCategoryModal() {
      document.getElementById('modalCategoryName').value = '';
      document.querySelector('input[name="categoryType"][value="main"]').checked = true;
      document.getElementById('parentCategoryGroup').style.display = 'none';
      document.getElementById('categoryModal').style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Rapor oluşturma fonksiyonu
    async function generateReport() {
      const date = document.getElementById('reportDate').value;
      if (!date) {
        showMessage('reportMessage', 'Lütfen bir tarih seçin.', 'error');
        return;
      }

      showMessage('reportMessage', 'Rapor oluşturuluyor...', 'warning');

      try {
        // 1. Firestore'dan verileri çek
        const startDate = new Date(date);
        startDate.setHours(0, 0, 0, 0);
        const endDate = new Date(date);
        endDate.setHours(23, 59, 59, 999);

        // Sipariş verileri
        const salesSnapshot = await db.collection("sales")
          .where("timestamp", ">=", startDate)
          .where("timestamp", "<=", endDate)
          .get();

        // Stok hareketleri
        const stockSnapshot = await db.collection("stock_history")
          .where("date", ">=", startDate)
          .where("date", "<=", endDate)
          .get();

        if (salesSnapshot.empty) {
          showMessage('reportMessage', 'Seçilen tarihte sipariş yok.', 'error');
          return;
        }

        // 2. Rapor verilerini işle
        const reportData = {
          date: new Date(date).toLocaleDateString('tr-TR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }),
          totalSales: 0,
          totalProducts: 0,
          totalRevenue: 0,
          popularProducts: {},
          stockOperations: [],
          hourlySales: {}
        };

        // Sipariş analizi
        salesSnapshot.forEach(doc => {
          const sale = doc.data();
          reportData.totalSales++;
          reportData.totalRevenue += sale.total || 0;

          // Saatlik satış analizi
          const hour = sale.timestamp.toDate().getHours();
          reportData.hourlySales[hour] = (reportData.hourlySales[hour] || 0) + 1;

          // Ürün analizi
          sale.items.forEach(item => {
            reportData.totalProducts += item.qty;
            reportData.popularProducts[item.product] = 
              (reportData.popularProducts[item.product] || 0) + item.qty;
          });
        });

        // Stok hareketleri
        stockSnapshot.forEach(doc => {
          const stock = doc.data();
          reportData.stockOperations.push({
            time: stock.date.toDate().toLocaleTimeString('tr-TR'),
            product: stock.productName,
            amount: `${stock.operation === 'ekleme' ? '+' : '-'}${stock.amount} ${stock.unit}`
          });
        });

        // Pik saatleri bul
        const peakHours = Object.entries(reportData.hourlySales)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 2)
          .map(([hour, count]) => `${hour}:00-${hour + 1}:00 → ${count} siparis`);

        // 3. PDF oluştur
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        
        doc.setFont("couriers");
        doc.setFontSize(10);

        // Başlık
        doc.setFontSize(14);
        doc.setFont("courier", "bold");
        doc.text("KAHVECIM - Gunluk Ozet", 105, 20, { align: 'center' });

        // Tarih
        doc.setFontSize(10);
        doc.setFont("arial", "bold");
        doc.text(`Rapor Tarihi: ${reportData.date}`, 14, 30);

         // 1. Genel Özet Tablosu
      doc.autoTable({
      startY: 40,
      head: [['GENEL ÖZET', '']],
      body: [
        ['Toplam Siparis', reportData.totalSales],
        ['Toplam Urun Adedi', `${reportData.totalProducts} adet`],
        ['Toplam Ciro', `${reportData.totalRevenue} TL`],
        ['Ort. Siparis Tutari', `${Math.round(reportData.totalRevenue / reportData.totalSales)} TL`],
      ],
      styles: {
        font: "courier",
        fontSize: 10,
        cellPadding: 5,
        lineWidth: 0.3, // İnce çizgiler
        lineColor: 0 // Siyah çerçeve
      },
      headStyles: {
        fontStyle: 'bold',
        fillColor: false, // Arkaplan rengi kaldırıldı
        textColor: 0, // Siyah metin
        lineWidth: 0.3
      }
    });

        // 2. En Çok Satanlar
    doc.autoTable({
      startY: doc.lastAutoTable.finalY + 15,
      head: [['EN COK SATANLAR (Top 5)', 'Adet']],
      body: Object.entries(reportData.popularProducts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([product, qty]) => [product, `${qty} adet`]),
      styles: {
        font: "arial",
        fontSize: 10,
        lineWidth: 0.2,
        lineColor: 0
      },
      headStyles: {
        fontStyle: 'bold',
        fillColor: false,
        textColor: 0,
        lineWidth: 0.2
      }
    });
        
        // 3. Stok Hareketleri
    if (reportData.stockOperations.length > 0) {
      doc.autoTable({
        startY: doc.lastAutoTable.finalY + 15,
        head: [['STOK HAREKETLERI', 'Miktar']],
        body: reportData.stockOperations.map(op => [op.time + ' - ' + op.product, op.amount]),
        styles: {
          font: "arial",
          fontSize: 11,
          lineWidth: 0.2,
          lineColor: 0
        },
        headStyles: {
          fontStyle: 'bold',
          fillColor: false,
          textColor: 0,
          lineWidth: 0.2
        }
      });
    }

        // 4. Pik Saatler
         doc.autoTable({
      startY: doc.lastAutoTable.finalY + 15,
      head: [['Pik Saatler', '']],
      body: peakHours.map(hour => [hour]),
      styles: {
        font: "arial",
        fontSize: 10,
        lineWidth: 0.1,
        lineColor: 0
      },
      headStyles: {
        fontStyle: 'bold',
        fillColor: false,
        textColor: 0,
        lineWidth: 0.1
      }
    });

        // 5. Footer
        doc.setFontSize(10);
    doc.text(`© ${new Date().getFullYear()} Kahvecim - Olusturulma Tarihi: ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });

    
        // 4. PDF'i indir
        doc.save(`kahvecim_rapor_${date}.pdf`);
        showMessage('reportMessage', '✔️ Rapor hazır!', 'success');

      } catch (error) {
        console.error("Hata:", error);
        showMessage('reportMessage', '❌ Hata: ' + error.message, 'error');
      }
    }

    // Modalı açan fonksiyon
    function openReportModal() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('reportDate').value = today;
      document.getElementById('reportLink').style.display = 'none';
      document.getElementById('reportMessage').style.display = 'none';
      document.getElementById('reportModal').style.display = 'flex';
    }

    // Yardımcı fonksiyonlar
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      element.textContent = message;
      element.className = `message ${type}`;
      element.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          element.style.display = 'none';
        }, 3000);
      }
    }

    // Global fonksiyonlar
    window.urunEkle = urunEkle;
    window.stokEkle = stokEkle;
    window.addIngredientField = addIngredientField;
    window.saveNewProduct = saveNewProduct;
    window.deleteProduct = deleteProduct;
    window.openCategoryModal = openCategoryModal;
    window.closeModal = closeModal;
    window.saveCategory = saveCategory;
    window.deleteUser = deleteUser;
    window.deleteCategory = deleteCategory;
    window.cancelStockOperation = function() {
      alert("Stok işlemi iptal edildi");
    };
    window.openRefundModal = openRefundModal;
    window.toggleParentSelect = toggleParentSelect;
    window.processRefund = processRefund;
    window.generateReport = generateReport;
    window.openReportModal = openReportModal;
    window.cancelSelectedOrder = cancelSelectedOrder;


        window.openAddStockExpenseModal = openAddStockExpenseModal;
        window.saveStockExpense = saveStockExpense;
        window.deleteExpense = deleteExpense;

          window.openStockReportModal = openStockReportModal;
          window.generateStockReport = generateStockReport;
          window.openOrderReportModal = openOrderReportModal;
          window.generateOrderReport = generateOrderReport;

  </script>
</body>
</html>