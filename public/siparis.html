<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Personel Paneli - Sipariş Al</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- CSS kısımları buraya gelecek -->

 <style>
    :root {
      /* Light Theme (Varsayılan) */
      --primary: #5a67d8;
      --primary-light: #7e8de3;
      --primary-dark: #4c51bf;
      --danger: #e53e3e;
      --success: #38a169;
      --warning: #dd6b20;
      --dark: #2d3748;
      --light: #f7fafc;
      --white: #ffffff;
      --gray-100: #f8f9fa;
      --gray-200: #e9ecef;
      --shadow: 0 6px 15px rgba(0,0,0,0.1);
      --shadow-hover: 0 10px 25px rgba(0,0,0,0.15);
      --radius: 14px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      
      /* Background ve Text renkleri */
      --bg-primary: #fafafa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f0f2f5;
      --text-primary: #333333;
      --text-secondary: #666666;
      --text-muted: #999999;
      --border-color: #e0e6ed;
      --border-light: #f0f0f0;
    }
    
    /* Dark Theme */
    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #3a3a3a;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --text-muted: #888888;
      --border-color: #404040;
      --border-light: #505050;
      --gray-100: #2d2d2d;
      --gray-200: #404040;
      --light: #2d2d2d;
      --white: #2d2d2d;
      --shadow: 0 6px 15px rgba(0,0,0,0.3);
      --shadow-hover: 0 10px 25px rgba(0,0,0,0.4);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      touch-action: manipulation;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1600px;
      margin: 20px auto;
      padding: 15px;
      background: var(--bg-primary);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      color: var(--text-primary);
      background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-primary) 100%);
      transition: var(--transition);
    }
    
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--text-primary);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
      font-weight: 700;
      font-size: 28px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    /* YENİ İKİ SÜTUNLU DÜZEN */
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .left-column {
      flex: 1;
      min-width: 65%;
    }
    
    .right-column {
      flex: 1;
      min-width: 32%;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* KATEGORİ STİLLERİ */
    .main-categories {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 10px;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      border: 1px solid var(--border-color);
    }
    
    .main-category-btn {
      padding: 22px 25px;
      background: var(--bg-secondary);
      border: 2px solid var(--primary-light);
      border-radius: 50px;
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 3px 8px rgba(74, 137, 220, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 5px;
      font-size: 17px;
      min-width: 150px;
    }
    
    .main-category-btn:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
    }
    
    .main-category-btn.active {
      background: var(--primary);
      color: var(--white);
      border-color: var(--primary);
      transform: scale(1.05);
      box-shadow: 0 10px 20px rgba(74, 137, 220, 0.3);
    }
    
    .main-category-btn i {
      font-size: 20px;
    }

    /* ALT KATEGORİ VE ÜRÜNLER ALANI */
    .category-content-area {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--primary-light);
      display: none;
      text-align: center;
    }
    
    .category-content-area.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .subcategories {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
      justify-content: center;
    }
    
    .subcategory-btn {
      padding: 18px 20px;
      background: var(--bg-tertiary);
      border: none;
      border-radius: 50px;
      color: var(--text-primary);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      font-size: 16px;
    }
    
    .subcategory-btn:hover {
      background: #e0e6ed;
      transform: translateY(-3px);
    }
    
    .subcategory-btn.active {
      background: var(--primary);
      color: var(--white);
      box-shadow: 0 6px 12px rgba(74, 137, 220, 0.2);
    }
    
    .direct-products {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      justify-items: center;
    }
    
    .direct-product {
      background: var(--white);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      transition: var(--transition);
      border: 1px solid #e0e6ed;
      width: 100%;
      max-width: 160px;
    }
    
    .direct-product:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-hover);
      border-color: var(--primary);
    }
    
    .direct-product img {
      width: 100%;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #e0e6ed;
    }
    
    .direct-product .name {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 5px;
    }
    
    .direct-product .price {
      color: var(--success);
      font-weight: 700;
      font-size: 14px;
    }
    
    /* ÜRÜN SEÇİM ALANI - GRID YAPISI */
    .coffee-selection {
      margin-top: 25px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 20px;
      padding: 20px;
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      box-shadow: 0 5px 12px rgba(0,0,0,0.06);
      max-height: 600px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary) var(--bg-tertiary);
    }
    
    .coffee-selection::-webkit-scrollbar {
      width: 8px;
    }
    
    .coffee-selection::-webkit-scrollbar-track {
      background: var(--light);
      border-radius: 4px;
    }
    
    .coffee-selection::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }
    
    .coffee-option {
      cursor: pointer;
      border: 3px solid transparent;
      border-radius: 16px;
      padding: 15px;
      text-align: center;
      background: var(--bg-secondary);
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);
      transition: var(--transition);
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      height: 200px;
      width: 100%;
      justify-content: space-between;
    }
    
    .coffee-option:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-5px);
    }
    
    .coffee-option.selected {
      border-color: var(--primary);
      box-shadow: 0 0 20px rgba(90, 103, 216, 0.6);
      background-color: var(--light);
    }
    
    .coffee-option img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 10px;
      filter: drop-shadow(0 3px 3px rgba(0,0,0,0.1));
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
    }
    
    .coffee-option p {
      font-weight: 700;
      color: var(--text-primary);
      font-size: 16px;
      margin: 0;
      user-select: none;
      line-height: 1.2;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .coffee-option .price {
      color: var(--success);
      font-weight: 700;
      margin-top: 5px;
      font-size: 15px;
    }
    
    /* Satış sayısı badge'i */
    .sales-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--primary);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1;
    }
    
    /* Ürün yükleme göstergesi */
    .products-loading {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-primary);
    }
    
    .loading-progress {
      width: 100%;
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      margin: 20px 0;
      overflow: hidden;
    }
    
    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-light));
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    .loading-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .loading-details {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }
    
    /* Skeleton loading */
    .skeleton-product {
      background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--border-color) 50%, var(--bg-tertiary) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 16px;
      height: 200px;
      margin-bottom: 20px;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    label {
      display: block;
      margin-bottom: 15px;
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
      user-select: none;
      background: var(--bg-tertiary);
      padding: 12px 18px;
      border-radius: var(--radius);
      box-shadow: 0 3px 6px rgba(0,0,0,0.05);
    }
    
    /* Boyut Seçimi Stilleri */
    .size-selection {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 15px 0;
      display: none; /* Başlangıçta gizli */
      flex-wrap: wrap;
    }
    
    .size-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 15px;
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
      min-width: 80px;
    }
    
    .size-btn:hover {
      background: #f8fbff;
      transform: translateY(-3px);
    }
    
    .size-btn.selected {
  border-color: var(--primary);
  background: var(--primary);
  color: var(--white);
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(90, 103, 216, 0.2);
}
    
    .size-btn i {
      font-size: 24px;
      margin-bottom: 8px;
      color: #a97443;
    }
    
    .size-btn .size-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }
    
    .size-btn .size-price {
      font-weight: 700;
      color: var(--success);
      font-size: 13px;
      margin-top: 4px;
    }
    
    .quantity-container {
      display: flex;
      gap: 15px;
      align-items: center;
      max-width: 220px;
      margin: 20px auto;
      background: var(--bg-tertiary);
      padding: 12px;
      border-radius: var(--radius);
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
    }
    
    .quantity-container button {
      flex: 1;
      padding: 15px 0;
      background-color: var(--primary-dark);
      border: none;
      border-radius: var(--radius);
      color: white;
      font-weight: 700;
      font-size: 22px;
      cursor: pointer;
      transition: background-color 0.25s ease;
      user-select: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      min-width: 50px;
    }
    
    .quantity-container button:hover {
      background-color: var(--primary);
      transform: scale(1.05);
    }
    
    #quantity {
      width: 70px;
      text-align: center;
      font-size: 22px;
      font-weight: 700;
      border: 2px solid var(--primary-dark);
      border-radius: var(--radius);
      padding: 10px 0;
      background: var(--bg-secondary);
      color: var(--text-primary);
      user-select: none;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      align-items: center;
      justify-content: center;
    }
    
    .action-buttons button {
      padding: 18px 0;
      border-radius: 50px;
      color: white;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      transition: var(--transition);
      user-select: none;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 5px 12px rgba(0,0,0,0.12);
      flex: 1;
      min-width: 150px;
    }
    
    #addOrderBtn, #confirmBtn {
      min-width: 150px;
    }
    
    #refundBtn {
      min-width: 100px;
      padding: 15px 0;
      font-size: 16px;
    }
    
    #addOrderBtn { 
      background-color: var(--primary); 
    }
    #confirmBtn { 
      background-color: var(--success); 
    }
    #refundBtn { 
      background-color: var(--danger); 
    }
    
    #addOrderBtn:hover { 
      background-color: var(--primary-dark); 
    }
    #confirmBtn:hover { 
      background-color: #2f855a; 
    }
    #refundBtn:hover { 
      background-color: #c53030; 
    }
    
    #addNameBtn {
      cursor: pointer;
      transition: var(--transition);
      padding: 12px 18px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      margin-left: 10px;
      font-weight: 600;
    }
    
    #addNameBtn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }
    
    /* SAĞ SÜTUN STİLLERİ */
    .right-panel-section {
      background: var(--bg-secondary);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }
    
    .right-panel-section h3 {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      color: var(--text-primary);
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 20px;
    }
    
    .right-panel-section h3 i {
      margin-right: 10px;
    }
    
    #orderList, #customerView {
      min-height: 180px;
      max-height: 250px;
      overflow-y: auto;
      padding: 15px;
      border-radius: var(--radius);
      background: var(--bg-secondary);
      box-shadow: inset 0 0 10px rgba(224, 230, 237, 0.5);
      font-weight: 600;
      font-size: 17px;
      color: var(--text-primary);
      margin-bottom: 15px;
      user-select: text;
    }
    
    #orderList {
      position: relative;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px dashed #d5c48b;
    }
    
    .item-details {
      flex: 1;
    }
    
    .item-actions {
      display: flex;
      gap: 10px;
    }
    
    .remove-item, .note-btn {
      color: var(--danger);
      cursor: pointer;
      font-weight: bold;
      padding: 8px;
      border-radius: 50%;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }
    
    .note-btn {
      color: var(--primary);
    }
    
    .remove-item:hover {
      background: rgba(231, 76, 60, 0.1);
      transform: rotate(90deg);
    }
    
    .note-btn:hover {
      background: rgba(90, 103, 216, 0.1);
      transform: scale(1.1);
    }
    
    .order-note {
      font-size: 14px;
      color: #666;
      font-style: italic;
      margin-top: 5px;
      padding-left: 10px;
      border-left: 3px solid var(--primary);
    }
    
    #customerView {
      border: 2px dashed var(--warning);
      min-height: 120px;
      line-height: 1.5;
      background: var(--bg-tertiary);
    }
    
    .section {
      margin-top: 0;
      background: var(--bg-secondary);
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: 0 5px 12px rgba(0,0,0,0.06);
      border: 1px solid var(--border-color);
    }
    
    .collapsible {
      background-color: var(--bg-tertiary);
      cursor: pointer;
      padding: 18px 22px;
      border: none;
      text-align: left;
      outline: none;
      font-size: 19px;
      font-weight: 600;
      border-radius: var(--radius);
      color: var(--text-primary);
      user-select: none;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      margin-bottom: 12px;
      transition: var(--transition);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border-color);
      width: 100%;
    }
    
    .collapsible:hover {
      background-color: var(--border-color);
    }
    
    .collapsible.active {
      background-color: var(--primary-dark);
      color: white;
      box-shadow: 0 8px 16px rgba(59, 125, 216, 0.8);
    }
    
    .content {
      padding: 20px;
      display: none;
      border: 2px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 var(--radius) var(--radius);
      background-color: var(--bg-secondary);
      font-size: 16px;
      color: var(--text-primary);
      font-weight: 600;
      user-select: text;
      max-height: 350px;
      overflow-y: auto;
    }
    

    
      /* Modal sistemini tamamen yeniden düzenleyin - mevcut modal CSS'lerini silin ve bunlarla değiştirin */

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.75);
  z-index: 10000; /* Sabit ve yüksek değer */
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(3px);
}

.modal-content {
  background: var(--bg-secondary);
  padding: 30px;
  border-radius: var(--radius);
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 15px 40px rgba(0,0,0,0.25);
  position: relative;
  z-index: 10001;
  border: 1px solid var(--border-color);
}


.modal-content input[type="text"], 
.modal-content textarea,
#nameInput, 
#noteInput {
  width: 100%;
  padding: 15px;
  margin: 20px 0;
  font-size: 16px;
  border: 2px solid var(--border-color);
  border-radius: var(--radius);
  transition: all 0.3s ease;
  box-sizing: border-box;
  background: var(--bg-secondary) !important;
  color: var(--text-primary);
  position: relative;
  z-index: auto;
  pointer-events: auto;
  outline: none;
}

.modal-content input[type="text"]:focus, 
.modal-content textarea:focus,
#nameInput:focus, 
#noteInput:focus {
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.25) !important;
  outline: none !important;
  background: var(--bg-secondary) !important;
}

.modal-btn {
  position: relative;
  z-index: auto;
  pointer-events: auto;
  flex: 1;
  padding: 15px;
  border-radius: var(--radius);
  font-weight: 700;
  font-size: 17px;
  cursor: pointer;
  transition: var(--transition);
  text-align: center;
  user-select: none;
  touch-action: manipulation;
  border: none;
}








@keyframes modalFadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}


/* Input ve textarea için temel stiller */
#nameInput, #noteInput {
  transition: all 0.3s ease;
  min-height: 40px;
}

#nameInput:focus, #noteInput:focus {
  border-color: var(--primary) !important;
  box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.25) !important;
  outline: none;
}
    
    
    .close-btn {
      background: none;
      border: none;
      font-size: 32px;
      cursor: pointer;
      color: #777;
      transition: transform 0.2s;
    }
    
    .close-btn:hover {
      transform: rotate(90deg);
      color: #333;
    }
    
    .history-item {
      padding: 18px;
      border-radius: 12px;
      background: var(--bg-tertiary);
      margin-bottom: 15px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid var(--border-color);
    }
    
    .history-item:hover {
      background: var(--bg-secondary);
      border-color: var(--primary-light);
    }
    
    .history-item.selected {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--white);
    }
    
    .history-item .order-id {
      font-weight: bold;
      color: var(--primary);
    }
    
    .history-item .items {
      margin: 10px 0;
      color: #555;
    }
    
    .history-item .total {
      font-weight: bold;
      color: var(--success);
    }
    
    .history-item .date {
      font-size: 15px;
      color: #777;
    }
    
    .refund-actions {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }
    
    .refund-actions button {
      flex: 1;
      padding: 14px;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .refund-actions button:hover {
      transform: translateY(-3px);
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
      border: none;
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
      border: none;
    }
    
    .refund-item {
      padding: 12px;
      margin: 8px 0;
      background: #f9f9f9;
      border-radius: var(--radius);
      border: 1px solid #eee;
    }
    
    .refund-item label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      background: none;
      padding: 0;
      box-shadow: none;
      font-weight: 500;
    }
    
    .refund-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .search-container {
      margin: 25px 0;
      display: flex;
      gap: 12px;
    }
    
    #productSearch {
      flex: 1;
      padding: 15px 20px;
      border: 2px solid var(--border-color);
      border-radius: 50px;
      font-size: 17px;
      outline: none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      transition: var(--transition);
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    
    #productSearch:focus {
      border-color: var(--primary);
      box-shadow: 0 3px 15px rgba(90, 103, 216, 0.25);
      background: var(--bg-secondary);
    }
    
    .search-container button {
      padding: 0 25px;
      background: var(--danger);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: bold;
      transition: var(--transition);
      font-size: 16px;
    }
    
    .search-container button:hover {
      background: #c0392b;
      transform: scale(1.05);
    }
    
    .canceled-order {
      background-color: #ffeeee !important;
      color: #999;
    }
    
    .canceled-order td {
      text-decoration: line-through;
    }
    
    .status-canceled {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 15px;
    }
    
    .history-table th, 
    .history-table td {
      padding: 10px 15px;
      border: 1px solid #e0e0e0;
      text-align: left;
    }
    
    .history-table th {
      background-color: var(--bg-tertiary);
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .history-table tr:nth-child(even) {
      background-color: var(--bg-tertiary);
    }
    
    .history-table tr:hover {
      background-color: var(--bg-secondary);
    }
    
   

   


@keyframes ripple {
  0% {
    transform: scale(0, 0);
    opacity: 1;
  }
  100% {
    transform: scale(20, 20);
    opacity: 0;
  }
}


    
    
    .btn-yes {
      background: var(--success);
      color: white;
    }
    
    .btn-no {
      background: var(--warning);
      color: white;
    }
    
    .btn-cancel {
      background: var(--danger);
      color: white;
    }
    
    
    
    .note-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.25);
      background: var(--bg-secondary);
    }
    
    /* MOBİL UYUMLULUK */
    @media (max-width: 768px) {
      body {
        padding: 15px;
        margin: 15px auto;
      }
      
      .container {
        flex-direction: column;
        gap: 15px;
      }
      
      .left-column, .right-column {
        min-width: 100%;
      }
      
      .main-categories {
        flex-direction: column;
        align-items: center;
      }
      
      .main-category-btn {
        width: 100%;
        justify-content: center;
      }
      
      .coffee-selection {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        padding: 12px;
        max-height: 500px;
      }
      
      .coffee-option {
        height: 180px;
        padding: 12px;
      }
      
      /* Mobilde theme toggle butonunu düzenle */
      h2 {
        flex-direction: column;
        gap: 15px;
      }
      
      h2 > div {
        flex-direction: column;
        gap: 10px;
      }
      
      #themeToggle, #refreshBtn {
        width: 100%;
        max-width: 200px;
      }
      
      .size-selection {
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .size-btn {
        min-width: 70px;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 15px;
      }
      
      .direct-products {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      #orderList, #customerView {
        max-height: 300px;
      }
      
    
      .btn-gift {
  background-color: #9c27b0 !important;
  color: white !important;
}


        @media print {
    body * {
      visibility: hidden; /* Ana sayfadaki her şeyi gizle */
    }
    #receipt-print-area, #receipt-print-area * {
      visibility: visible; /* Sadece fişi göster */
    }
    #receipt-print-area {
      position: absolute;
      left: 0;
      top: 0;
      width: 80mm; /* Fiş genişliği */
      padding: 0;
      margin: 0;
      font-size: 14px;
    }
  }

      .toggle-button {
  padding: 12px 20px;
  background-color: var(--success);
  color: white;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  box-shadow: var(--shadow);
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 8px;
}

    .toggle-button.off {
      background-color: var(--danger);
    }
    
    /* Theme toggle button */
    #themeToggle {
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    #themeToggle:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-hover);
    }
    
    #themeToggle[data-theme="dark"] {
      background: var(--warning) !important;
    }
    
    #themeToggle[data-theme="dark"] i {
      transform: rotate(180deg);
    }




    #nameInput, #noteInput {
      transition: all 0.2s ease;
    }
    






.loader {
  border: 5px solid #f3f3f3;
  border-top: 5px solid #5a67d8;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
  display: none; /* Başlangıçta gizli */
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.8);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  display: none; /* Başlangıçta gizli */
}


    }


  </style>




  
</head>
<body>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loader"></div>
    <p style="margin-top: 20px; font-weight: bold;">Yükleniyor...</p>
  </div>

  <h2>
    <i class="fas fa-coffee"></i> Personel Paneli - Kahve Siparişi
    <div style="display: flex; gap: 15px; align-items: center; margin-left: 15px;">
      <button id="themeToggle" style="padding: 5px 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">
        <i class="fas fa-moon"></i> Dark Mode
      </button>
      <button id="refreshBtn" style="padding: 5px 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer;">
        <i class="fas fa-sync-alt"></i> Sayfayı Yenile
      </button>
    </div>
  </h2>
  
  <div class="search-container">
    <input type="text" id="productSearch" placeholder="Ürün ara..." />
    <button onclick="clearSearch()">
      <i class="fas fa-times"></i> Temizle
    </button>
  </div>

  <div class="container">
    <div class="left-column">
      <!-- KATEGORİ YAPISI -->
      <div class="main-categories" id="mainCategories">
        <!-- Ana kategoriler buraya dinamik olarak eklenecek -->
      </div>
      
      <div id="categoryContent" class="category-content-area">
        <!-- Alt kategoriler ve doğrudan ürünler burada gösterilecek -->
      </div>

      <label>Ürün Seçimi:</label>
      <div id="kahveListesi" class="coffee-selection" role="list" aria-label="Ürün seçenekleri">
        <div class="no-product-message">Kategori seçin veya ürün seçin</div>
      </div>
      
      <!-- Boyut Seçim Alanı -->
      <div id="sizeSelection" class="size-selection">
        <!-- Boyut seçenekleri buraya dinamik olarak eklenecek -->
      </div>
      
      <div class="form-group">
        <label for="quantity">Adet:</label>
        <div class="quantity-container" role="group" aria-label="Adet seçimi">
          <button type="button" aria-label="Adet azalt" onclick="changeQty(-1)">-</button>
          <input type="text" id="quantity" value="1" readonly aria-live="polite" aria-atomic="true" />
          <button type="button" aria-label="Adet artır" onclick="changeQty(1)">+</button>
        </div>
      </div>

      <div class="action-buttons">
        <button id="addOrderBtn" onclick="addToOrder()">
          <i class="fas fa-plus"></i> Siparişe Ekle
        </button>
        <button id="confirmBtn" onclick="window.confirmOrder()">
          <i class="fas fa-check"></i> Siparişi Onayla
        </button>
        <button id="refundBtn" onclick="openRefundModal()">
          <i class="fas fa-exchange-alt"></i> İade
        </button>
      </div>
    </div> <!-- left-column sonu -->

    <div class="right-column">
      <div class="right-panel-section">
        <h3>
          <span><i class="fas fa-shopping-cart"></i> Aktif Sipariş</span>
          <button id="addNameBtn" onclick="addCustomerName()">
              <i class="fas fa-user-plus"></i> İsim Ekle
          </button>
        </h3>
        <div id="orderList" aria-live="polite"><i>Henüz sipariş eklenmedi.</i></div>
      </div>

      <div class="right-panel-section">
        <h3><i class="fas fa-user"></i> Müşteri Görünümü</h3>
        <div id="customerView" aria-live="polite"><i>Müşteri için sipariş özeti yok.</i></div>
      </div>

      <div class="section">
        <button class="collapsible" aria-expanded="false">
          <span><i class="fas fa-history"></i> Satış Geçmişi (Özet)</span>
          <i class="fas fa-chevron-down"></i>
        </button>
        <div class="content" id="salesSummary">
          <table class="history-table">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>Sipariş No</th>
                <th>Ürünler</th>
                <th>Toplam</th>
                <th>Durum</th>
              </tr>
            </thead>
            <tbody id="salesHistoryBody">
              <!-- Dinamik olarak dolacak -->
            </tbody>
          </table>
        </div>

        <button class="collapsible" aria-expanded="false">
          <span><i class="fas fa-chart-bar"></i> Toplam Satış Adetleri</span>
          <i class="fas fa-chevron-down"></i>
        </button>
        <div class="content" id="salesCounts"></div>
      </div>
    </div> <!-- right-column sonu -->
  </div> <!-- container sonu -->

  <!-- İade/Değişim Modal -->
  <div id="refundModal" class="modal">
    <div class="modal-content">
      <!-- Dinamik olarak oluşturulacak -->
    </div>
  </div>

  <!-- Stok Geri Ekleme Onay Modal -->
  <div id="refundConfirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Stok Geri Eklensin mi?</h3>
        <button class="close-btn" onclick="closeModal('refundConfirmModal')">&times;</button>
      </div>
      <p>İade edilen ürünlerin malzemeleri stoğa geri eklensin mi?</p>
      <div class="modal-btn-container">
        <button class="modal-btn btn-yes" onclick="refundConfirm(true)">Evet</button>
        <button class="modal-btn btn-no" onclick="refundConfirm(false)">Hayır</button>
        <button class="modal-btn btn-cancel" onclick="closeModal('refundConfirmModal')">İptal</button>
      </div>
    </div>
  </div>

  <!-- Müşteri İsmi Modal -->
  <div id="nameModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Müşteri İsmi</h3>
        <button class="close-btn" onclick="closeModal('nameModal')">&times;</button>
      </div>
      <input type="text" id="nameInput" placeholder="İsim giriniz..." class="note-input" 
             autocomplete="off" autocorrect="off" spellcheck="false" />
      <div class="modal-btn-container">
        <button class="modal-btn btn-primary" onclick="submitName()">Kaydet</button>
        <button class="modal-btn btn-cancel" onclick="closeModal('nameModal')">İptal</button>
      </div>
    </div>
  </div>

  <!-- Not Ekleme Modal -->
  <div id="noteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Sipariş Notu</h3>
        <button class="close-btn" onclick="closeModal('noteModal')">&times;</button>
      </div>
      <textarea id="noteInput" placeholder="Not giriniz..." class="note-input" rows="4"
                autocomplete="off" autocorrect="off" spellcheck="false"></textarea>
      <div class="modal-btn-container">
        <button class="modal-btn btn-primary" onclick="saveNote()">Kaydet</button>
        <button class="modal-btn btn-cancel" onclick="closeModal('noteModal')">İptal</button>
      </div>
    </div>
  </div>

  <!-- Ödeme Yöntemi Modal -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Ödeme Yöntemi</h3>
        <button class="close-btn" onclick="closeModal('paymentModal')">&times;</button>
      </div>
      <p style="text-align: center; font-size: 18px; margin: 20px 0;">
        Toplam Tutar: <span id="paymentTotalAmount">0.00</span>₺
      </p>
      <div class="modal-btn-container">
        <button class="modal-btn btn-primary" onclick="completeOrder('cash')">
          <i class="fas fa-money-bill-wave"></i> Nakit
        </button>
        <button class="modal-btn btn-primary" onclick="completeOrder('card')">
          <i class="fas fa-credit-card"></i> Kart
        </button>
        <button class="modal-btn btn-gift" onclick="completeOrder('gift')">
          <i class="fas fa-gift"></i> İkram
        </button>
        <button class="modal-btn btn-cancel" onclick="closeModal('paymentModal')">
          <i class="fas fa-times"></i> İptal
        </button>
      </div>
    </div>
  </div>

  <!-- Fiş Yazdırma Toggle Butonu -->
  <div id="receiptToggleContainer" style="position:fixed; bottom:20px; right:20px;">
    <button id="receiptToggle" class="toggle-button">
      <i class="fas fa-receipt"></i> Fiş Yazdırma: Açık
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      deleteDoc, 
      addDoc,
      serverTimestamp,
      doc,
      setDoc, 
      updateDoc,
      onSnapshot,
      getDocs,
      startAfter,
      query,
      where,
      orderBy,
      limit,
      getDoc,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
    import { 
      getAuth, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCyOAbT9CM76LvWrUYM4ZCl078O7mKmx_o",
      authDomain: "kahvesiparis1.firebaseapp.com",
      projectId: "kahvesiparis1",
      storageBucket: "kahvesiparis1.appspot.com",
      messagingSenderId: "358382107079",
      appId: "1:358382107079:web:37ccd0e80b73736a8681e2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Global değişkenler
    let productMenu = {};
    let productSpecs = {};
    let selectedProduct = "";
    let currentOrder = [];
    let stockData = {};
    let currentUserEmail = "";
    let selectedRefundItems = [];
    let selectedOrderForRefund = null;
    let currentCustomerName = "";
    let currentNoteIndex = -1;
    let selectedSize = "";
    let printReceiptEnabled = true;
    let paymentMethod = '';
    let unsubscribeOrder = null;
    let productSalesCache = {}; // Ürün satış sayıları için cache
    let salesDataLoaded = false; // Satış verilerinin yüklenip yüklenmediği
    let productsLoading = false; // Ürünlerin yüklenip yüklenmediği
    let loadingProgress = 0; // Yükleme ilerlemesi
    let productCache = {}; // Ürün detayları için cache
    let categoryCache = {}; // Kategori verileri için cache
    let stockCache = {}; // Stok verileri için cache
    let cacheTimestamp = {}; // Cache zaman damgaları
    let CACHE_DURATION = 5 * 60 * 1000; // 5 dakika cache süresi
    let currentTheme = 'light'; // Mevcut tema

        // Cache yönetim fonksiyonları
    function isCacheValid(cacheKey) {
      const timestamp = cacheTimestamp[cacheKey];
      if (!timestamp) return false;
      return (Date.now() - timestamp) < CACHE_DURATION;
    }
    
    function setCache(cacheKey, data) {
      productCache[cacheKey] = data;
      cacheTimestamp[cacheKey] = Date.now();
    }
    
    function getCache(cacheKey) {
      if (isCacheValid(cacheKey)) {
        return productCache[cacheKey];
      }
      return null;
    }
    
    function clearExpiredCache() {
      const now = Date.now();
      Object.keys(cacheTimestamp).forEach(key => {
        if ((now - cacheTimestamp[key]) > CACHE_DURATION) {
          delete productCache[key];
          delete cacheTimestamp[key];
        }
      });
    }
    
    // Theme yönetim fonksiyonları
    function setTheme(theme) {
      currentTheme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      
      // Theme toggle butonunu güncelle
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        if (theme === 'dark') {
          themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
          themeToggle.setAttribute('data-theme', 'dark');
        } else {
          themeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
          themeToggle.removeAttribute('data-theme');
        }
      }
      
      console.log(`Tema değiştirildi: ${theme}`);
    }
    
    function toggleTheme() {
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      setTheme(newTheme);
    }
    
    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      setTheme(savedTheme);
    }
    
    // Modal yönetimi
    function openModal(modalId) {
      
      // Önce tüm modalları kapat
      document.querySelectorAll('.modal').forEach(modal => {
        modal.style.display = 'none';
      });
      
      const modal = document.getElementById(modalId);
      if (!modal) {
        console.error('Modal bulunamadı:', modalId);
        return;
      }
      
      // Body scroll'unu engelle
      document.body.style.overflow = 'hidden';
      
      // Modal'ı göster
      modal.style.display = 'flex';
      
      // Input'a odaklan
      setTimeout(() => {
        const input = modal.querySelector('input, textarea');
        if (input) {
          input.focus();
          if (input.value) input.select();
        }
      }, 100);
    }


   function closeModal(modalId) {
      console.log('Modal kapatılıyor:', modalId);
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        
        // Inputları temizle
        if (modalId === 'noteModal') {
          const noteInput = document.getElementById('noteInput');
          if (noteInput) noteInput.value = '';
          currentNoteIndex = -1;
        }
        
        if (modalId === 'nameModal') {
          const nameInput = document.getElementById('nameInput');
          if (nameInput) nameInput.value = '';
        }
      }
    }

    // Global modal event listener'ı
    document.addEventListener('click', (e) => {
      // Dışarı tıklayarak kapatma
      if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
        document.body.style.overflow = '';
      }
    });

    // ESC tuşu ile kapatma
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal').forEach(modal => {
          modal.style.display = 'none';
        });
        document.body.style.overflow = '';
      }
    });

    // Modal içeriği için event bubbling önleme
    document.querySelectorAll('.modal-content').forEach(content => {
      content.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    });

    // BOYUT SEÇİMİ
    function selectSize(size, event) {
      event?.preventDefault();
      selectedSize = size;
      
      document.querySelectorAll('.size-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      if (event) {
        event.currentTarget.classList.add('selected');
      }
      
      // Fiyat güncelleme - önce cache'den dene
      let product = getCache(`product_${selectedProduct}`);
      if (!product) {
        product = productSpecs[selectedProduct];
        if (product) {
          setCache(`product_${selectedProduct}`, product);
        }
      }
      
      if (product && product.sizes && product.sizes[size]) {
        const price = product.sizes[size].price.toFixed(2);
        document.querySelector('.size-btn.selected .size-price').textContent = `${price}₺`;
      }
    }

    // Boyut seçeneklerini oluştur
    function createSizeOptions(product) {
      const sizeContainer = document.getElementById('sizeSelection');
      sizeContainer.innerHTML = '';
      
      if (!product || !product.sizes || Object.keys(product.sizes).length === 0) {
        sizeContainer.style.display = 'none';
        return;
      }
      
      sizeContainer.style.display = 'flex';
      
      const sizeOrder = ["küçük", "orta", "büyük"];
      const sortedSizes = Object.keys(product.sizes).sort((a, b) => {
        const ai = sizeOrder.indexOf(a.toLowerCase());
        const bi = sizeOrder.indexOf(b.toLowerCase());
        if (ai === -1 && bi === -1) return a.localeCompare(b);
        if (ai === -1) return 1;
        if (bi === -1) return -1;
        return ai - bi;
      });

      sortedSizes.forEach(sizeName => {
        const sizeData = product.sizes[sizeName];
        const sizeBtn = document.createElement('div');
        sizeBtn.className = 'size-btn';
        sizeBtn.onclick = (e) => selectSize(sizeName, e);
        
        let icon = 'fa-mug-hot';
        if (sizeName.toLowerCase() === 'küçük') icon = 'fa-mug-saucer';
        if (sizeName.toLowerCase() === 'orta') icon = 'fa-mug';
        
        sizeBtn.innerHTML = `
          <i class="fas ${icon}"></i>
          <div class="size-name">${sizeName.charAt(0).toUpperCase() + sizeName.slice(1)}</div>
          <div class="size-price">${sizeData.price.toFixed(2)}₺</div>
        `;
        
        sizeContainer.appendChild(sizeBtn);
      });
      
      // İlk boyutu otomatik seç
      if (sizeContainer.children.length > 0) {
        sizeContainer.children[0].classList.add('selected');
        selectedSize = sortedSizes[0];
      }
    }

    // İsim ekleme fonksiyonları
    window.addCustomerName = function() {
      console.log('İsim ekleme modalı açılıyor');
      const nameInput = document.getElementById('nameInput');
      if (nameInput) {
        nameInput.value = currentCustomerName || '';
      }
      openModal('nameModal');
    };


   window.submitName = function() {
      const nameInput = document.getElementById('nameInput');
      if (!nameInput) {
        console.error('Name input bulunamadı');
        return;
      }
      
      const name = nameInput.value.trim();
      if (name) {
        currentCustomerName = name;
        updateOrderDisplay();
        saveActiveOrder().catch(console.error);
      }
      
      closeModal('nameModal');
    };

    // Not ekleme fonksiyonları
    window.openNoteModal = function(index) {
      currentNoteIndex = index;
      const noteInput = document.getElementById('noteInput');
      if (noteInput && currentOrder[index]) {
        noteInput.value = currentOrder[index].note || '';
      }
      openModal('noteModal');
    };


     window.saveNote = function() {
      const noteInput = document.getElementById('noteInput');
      if (!noteInput) {
        console.error('Note input bulunamadı');
        return;
      }
      
      const note = noteInput.value.trim();
      if (currentNoteIndex !== -1 && currentOrder[currentNoteIndex]) {
        currentOrder[currentNoteIndex].note = note;
        updateOrderDisplay();
        saveActiveOrder().catch(console.error);
      }
      
      closeModal('noteModal');
    };


    // Kategori yükleme fonksiyonu
    async function loadCategories() {
      const container = document.getElementById('mainCategories');
      const contentArea = document.getElementById('categoryContent');
      container.innerHTML = '';
      contentArea.innerHTML = '';
      
      try {
        const querySnapshot = await getDocs(
          query(
            collection(db, "categories"),
            orderBy("order")
          )
        );
        
        const allCats = [];
        querySnapshot.forEach(doc => {
          allCats.push({ id: doc.id, ...doc.data() });
        });

        const mainCategories = allCats
          .filter(cat => !cat.parent)
          .sort((a, b) => (a.order || 0) - (b.order || 0));

        const subCategories = allCats
          .filter(cat => cat.parent)
          .sort((a, b) => (a.order || 0) - (b.order || 0));

        // Kategorileri cache'e ekle
        setCache('mainCategories', mainCategories);
        setCache('subCategories', subCategories);
        console.log('Kategoriler cache\'e eklendi');

        mainCategories.forEach((mainCat, index) => {
          const btn = document.createElement('button');
          btn.className = 'main-category-btn';
          if (index === 0) btn.classList.add('active');
          btn.dataset.id = mainCat.id;
          btn.dataset.slug = mainCat.slug;
          
          btn.innerHTML = `
            <i class="fas ${mainCat.icon || 'fa-utensils'}"></i>
            ${mainCat.name}
          `;
          
          btn.addEventListener('click', () => {
            document.querySelectorAll('.main-category-btn').forEach(b => {
              b.classList.remove('active');
            });
            btn.classList.add('active');
            showCategoryContent(mainCat, subCategories);
          });
          
          container.appendChild(btn);
          
          // İlk kategoriyi otomatik olarak seç ve ürünleri göster
          if (index === 0) {
            // Kısa bir gecikme ile ilk kategoriyi seç (DOM hazır olduktan sonra)
            setTimeout(() => {
              showCategoryContent(mainCat, subCategories);
            }, 100);
          }
        });

      } catch (error) {
        console.error("Kategoriler yüklenemedi:", error);
      }
    }
    
    // Kategori içeriğini göster
    function showCategoryContent(mainCat, allSubCategories) {
      const contentArea = document.getElementById('categoryContent');
      
      const subCategories = allSubCategories
        .filter(subCat => subCat.parent === mainCat.id)
        .sort((a, b) => (a.order || 0) - (b.order || 0));

      let contentHTML = '';
      
      if (subCategories.length > 0) {
        contentHTML += `
          <div class="subcategories">
            ${subCategories.map(subCat => `
              <button class="subcategory-btn" data-slug="${subCat.slug}">
                ${subCat.name}
              </button>
            `).join('')}
          </div>
        `;
      }
      
      contentArea.innerHTML = contentHTML;
      contentArea.classList.add('active');
      
      contentArea.querySelectorAll('.subcategory-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          selectSubCategory(this.dataset.slug);
        });
      });
      
      if (subCategories.length > 0) {
        const firstSubBtn = contentArea.querySelector('.subcategory-btn');
        if (firstSubBtn) {
          selectSubCategory(firstSubBtn.dataset.slug);
        }
      } else {
        // Ürünleri direkt listele (loading olmadan)
        listProducts(mainCat.slug);
      }
    }

    // Alt kategori seçimi
    function selectSubCategory(slug) {
      document.querySelectorAll('.subcategory-btn').forEach(btn => {
        btn.classList.remove("active");
      });
      
      const activeBtn = document.querySelector(`.subcategory-btn[data-slug="${slug}"]`);
      if (activeBtn) {
        activeBtn.classList.add("active");
      }
      
      // Ürünleri direkt listele (loading olmadan)
      listProducts(slug);
    }

    // Ürün yükleme göstergesi
    function showProductsLoading(category) {
      const productListDiv = document.getElementById("kahveListesi");
      productListDiv.innerHTML = `
        <div class="products-loading">
          <div class="loading-text">
            <i class="fas fa-spinner fa-spin"></i> Ürünler yükleniyor...
          </div>
          <div class="loading-details">
            ${category} kategorisindeki ürünler hazırlanıyor
          </div>
          <div class="loading-progress">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
          </div>
          <div style="font-size: 12px; color: #999;">
            Lütfen bekleyin...
          </div>
        </div>
      `;
      
      // Progress bar animasyonu
      const progressBar = document.getElementById('loadingProgressBar');
      if (progressBar) {
        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress >= 90) {
            progress = 90;
            clearInterval(interval);
          }
          progressBar.style.width = progress + '%';
        }, 200);
      }
    }
    
    // Skeleton loading göster
    function showSkeletonLoading() {
      const productListDiv = document.getElementById("kahveListesi");
      let skeletonHTML = '';
      
      // 6 adet skeleton ürün kartı oluştur
      for (let i = 0; i < 6; i++) {
        skeletonHTML += '<div class="skeleton-product"></div>';
      }
      
      productListDiv.innerHTML = skeletonHTML;
    }
    
    // Ürünleri listele
    function listProducts(category) {
      const productListDiv = document.getElementById("kahveListesi");
      productListDiv.innerHTML = "";
      selectedProduct = "";
      
      if (!productMenu[category]) {
        productListDiv.innerHTML = '<div class="no-product-message">Bu kategoride ürün bulunamadı.</div>';
        return;
      }
      
      let sortedProducts = [...productMenu[category]];
      
      // Eğer satış verileri yüklendiyse, satış sayılarına göre sırala
      if (salesDataLoaded && Object.keys(productSalesCache).length > 0) {
        sortedProducts.sort((a, b) => {
          const salesA = productSalesCache[a.ad] || 0;
          const salesB = productSalesCache[b.ad] || 0;
          
          // Önce satış sayısına göre azalan sıralama
          if (salesB !== salesA) {
            return salesB - salesA;
          }
          
          // Satış sayısı aynıysa order'a göre sırala
          return (a.order || 0) - (b.order || 0);
        });
      } else {
        // Satış verileri yoksa sadece order'a göre sırala
        sortedProducts.sort((a, b) => (a.order || 0) - (b.order || 0));
      }

      document.querySelectorAll(".coffee-option").forEach(opt => {
        opt.classList.remove("selected");
        opt.setAttribute("aria-pressed", "false");
      });
      
      // Ürünleri direkt göster (loading gecikmesi olmadan)
      sortedProducts.forEach(product => {
        const div = createProductElement(product);
        productListDiv.appendChild(div);
      });
    }

    // Ürün elemanı oluşturma fonksiyonu
    function createProductElement(product) {
      const div = document.createElement("div");
      div.className = "coffee-option";
      div.dataset.name = product.ad;
      div.tabIndex = 0;
      div.setAttribute("role", "button");
      div.setAttribute("aria-pressed", "false");

      const price = product.price?.toFixed?.(2) || "0.00";
      
      // Satış sayısı bilgisini al
      const salesCount = productSalesCache[product.ad] || 0;
      const salesBadge = salesCount > 0 ? `<div class="sales-badge">${salesCount} satış</div>` : '';

      div.innerHTML = `
        <img src="${product.resim}" 
             alt="${product.ad}" 
             onerror="this.onerror=null; this.src='img/placeholder.jpg'" />
        ${salesBadge}
        <p>${product.ad}</p>
        <div class="price">${price}₺</div>
      `;
      
      div.addEventListener("click", () => {
        selectProduct(div, product.ad);
        createSizeOptions(productSpecs[product.ad]);
      });
      
      div.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          selectProduct(div, product.ad);
          createSizeOptions(productSpecs[product.ad]);
        }
      });
      
      return div;
    }

    // Ürün seçimi
    function selectProduct(div, productName) {
      document.querySelectorAll(".coffee-option").forEach(opt => {
        opt.classList.remove("selected");
        opt.setAttribute("aria-pressed", "false");
      });
      div.classList.add("selected");
      div.setAttribute("aria-pressed", "true");
      selectedProduct = productName;
      selectedSize = "";
      
      // Cache'den ürün bilgilerini al
      const cachedProduct = getCache(`product_${productName}`);
      if (cachedProduct) {
        console.log('Ürün cache\'den alındı:', productName);
        createSizeOptions(cachedProduct);
      } else {
        // Cache'de yoksa productSpecs'den al ve cache'le
        const product = productSpecs[productName];
        if (product) {
          setCache(`product_${productName}`, product);
          console.log('Ürün cache\'e eklendi:', productName);
          createSizeOptions(product);
        }
      }
    }

    // Adet değiştirme
    function changeQty(delta) {
      const qtyInput = document.getElementById("quantity");
      let current = parseInt(qtyInput.value) || 1;
      current += delta;
      if (current < 1) current = 1;
      qtyInput.value = current;
    }

    // Siparişe ekleme
    function addToOrder() {
      const qty = parseInt(document.getElementById("quantity").value);
      if (!selectedProduct || isNaN(qty) || qty <= 0) {
        alert("Lütfen bir ürün seçin ve adet belirtin.");
        return;
      }
      
      let price = productSpecs[selectedProduct]?.price || 0;
      let sizeInfo = "";
      
      if (selectedSize && productSpecs[selectedProduct]?.sizes?.[selectedSize]) {
        price = productSpecs[selectedProduct].sizes[selectedSize].price;
        sizeInfo = ` (${selectedSize.charAt(0).toUpperCase() + selectedSize.slice(1)})`;
      }

      const existingIndex = currentOrder.findIndex(item => 
        item.product === selectedProduct && item.size === selectedSize
      );
      
      if (existingIndex !== -1) {
        currentOrder[existingIndex].qty += qty;
      } else {
        currentOrder.push({ 
          product: selectedProduct, 
          qty,
          price: price,
          size: selectedSize,
          image: productSpecs[selectedProduct]?.image || "",
          note: ""
        });
      }
      
      updateOrderDisplay();
      selectedProduct = "";
      selectedSize = "";
      document.querySelectorAll(".coffee-option").forEach(opt => {
        opt.classList.remove("selected");
        opt.setAttribute("aria-pressed", "false");
      });
      document.getElementById("quantity").value = 1;
      document.getElementById("sizeSelection").style.display = "none";

      saveActiveOrder();
    }

    // Siparişi güncelle
    function updateOrderDisplay() {
      const listDiv = document.getElementById("orderList");
      const customerView = document.getElementById("customerView");

      if (currentOrder.length === 0) {
        listDiv.innerHTML = "<i>Henüz sipariş eklenmedi.</i>";
        customerView.innerHTML = "<i>Müşteri için sipariş özeti yok.</i>";
        return;
      }

      let htmlList = "";

      if (currentCustomerName) {
        htmlList += `
          <div class="order-item">
            <div class="item-details">
              <strong>Müşteri:</strong> ${currentCustomerName}
            </div>
          </div>
        `;
      }

      currentOrder.forEach((item, index) => {
        const price = item.price.toFixed(2) || "0.00";
        const sizeInfo = item.size ? ` (${item.size.charAt(0).toUpperCase() + item.size.slice(1)})` : '';
        
        htmlList += `
          <div class="order-item">
            <div class="item-details">
              <div>${item.qty} x ${item.product}${sizeInfo} (${price}₺)</div>
              ${item.note ? `<div class="order-note">${item.note}</div>` : ''}
            </div>
            <div class="item-actions">
              <div class="note-btn" onclick="openNoteModal(${index})">
                <i class="fas fa-comment"></i>
              </div>
              <div class="remove-item" onclick="removeFromOrder(${index})">
                <i class="fas fa-times"></i>
              </div>
            </div>
          </div>
        `;
      });

      listDiv.innerHTML = htmlList;

      const totalPrice = currentOrder.reduce((sum, item) => sum + (item.qty * item.price), 0);

      customerView.innerHTML = `
        <div>${htmlList.replace(/class="order-item"/g, 'class="order-item" style="border:none; padding:8px 0;"')}</div>
        <hr style="margin: 15px 0;">
        <div style="text-align: right; font-size: 20px;">
          <strong>Toplam: ${totalPrice.toFixed(2)}₺</strong>
        </div>
      `;
    }

    // Siparişten kaldırma
    function removeFromOrder(index) {
      currentOrder.splice(index, 1);
      updateOrderDisplay();
      saveActiveOrder(); 
    }

    async function printTickets(orderId, items, customerName = "", paymentMethod = "") {
      try {
        for (const item of items) {
          await addDoc(collection(db, "tickets"), {
            orderId,
            product: item.product,
            size: item.size || "",
            customerName,
            note: item.note || "",
            timestamp: serverTimestamp(),
            price: item.price,
            qty: item.qty,
            paymentMethod: paymentMethod
          });
        }
      } catch (error) {
        console.error("Fiş oluşturma hatası:", error);
      }
    }

    // Günlük fiş numarası al
    async function getDailyReceiptNumber() {
      try {
        const today = new Date().toISOString().split('T')[0];
        const counterRef = doc(db, "dailyReceiptCounters", today);
        
        const newNumber = await runTransaction(db, async (transaction) => {
          const counterDoc = await transaction.get(counterRef);
          
          if (counterDoc.exists()) {
            const newCount = counterDoc.data().count + 1;
            transaction.update(counterRef, { count: newCount });
            return newCount;
          } else {
            transaction.set(counterRef, { count: 1 });
            return 1;
          }
        });
        
        return newNumber;
      } catch (error) {
        console.error("Fiş numarası alınırken hata:", error);
        return 0;
      }
    }

    // Toplam satış adetlerini hesapla ve cache'le
    async function updateSalesCounts() {
      const salesCountsDiv = document.getElementById('salesCounts');
      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        const refundsSnapshot = await getDocs(collection(db, "refunds"));
        const refundedOrderIds = refundsSnapshot.docs.map(doc => doc.data().orderId);

        const q = query(
          collection(db, "sales"),
          where("timestamp", ">=", today),
          where("timestamp", "<", tomorrow)
        );

        const salesSnapshot = await getDocs(q);
        const productCounts = {};

        salesSnapshot.forEach(doc => {
          if (refundedOrderIds.includes(doc.id)) return;

          const order = doc.data();
          order.items.forEach(item => {
            if (!productCounts[item.product]) {
              productCounts[item.product] = 0;
            }
            productCounts[item.product] += item.qty;
          });
        });

        // Global cache'i güncelle
        productSalesCache = productCounts;
        salesDataLoaded = true;

        if (Object.keys(productCounts).length === 0) {
          salesCountsDiv.innerHTML = "<p>Bugün henüz satış yok.</p>";
          return;
        }

        let html = `
          <div style="margin-bottom: 10px; font-weight: bold; text-align: center;">
            ${today.toLocaleDateString('tr-TR')} Satışları
          </div>
          <ul style="list-style-type:none; padding:0; margin-top:10px;">
        `;
        
        const sortedProducts = Object.entries(productCounts)
          .sort((a, b) => b[1] - a[1]);

        for (const [product, count] of sortedProducts) {
          html += `
            <li style="padding:8px 10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
              <span>${product}:</span> 
              <span><strong>${count} adet</strong></span>
            </li>`;
        }
        html += '</ul>';

        salesCountsDiv.innerHTML = html;
      } catch (error) {
        console.error("Günlük satış adetleri yüklenirken hata:", error);
        salesCountsDiv.innerHTML = `<p>Hata: ${error.message}</p>`;
      }
    }

    async function saveActiveOrder() {
      const activeOrder = {
        items: currentOrder,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        total: calculateTotal(),
        status: "draft",
        customerName: currentCustomerName
      };

      const orderRef = doc(db, "active_orders", "tekSiparis");
      await setDoc(orderRef, activeOrder);
      window.activeOrderId = "tekSiparis";
    }

    function calculateTotal() {
      return currentOrder.reduce((sum, item) => sum + (item.qty * item.price), 0);
    }

    // Veri yüklemeye başlarken
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    // Veri yükleme tamamlanınca
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // Ürün arama fonksiyonu
    function searchProducts() {
      const searchTerm = document.getElementById('productSearch').value.toLowerCase();
      if (!searchTerm.trim()) {
        const activeMainBtn = document.querySelector('.main-category-btn.active');
        if (activeMainBtn) {
          const mainCatId = activeMainBtn.dataset.id;
          const mainCatSlug = activeMainBtn.dataset.slug;
          const mainCat = { id: mainCatId, slug: mainCatSlug };
          showCategoryContent(mainCat, []);
        }
        return;
      }

      const productListDiv = document.getElementById("kahveListesi");
      
      // Arama sonuçlarını direkt göster (loading olmadan)
      let foundProducts = [];
      for (const category in productMenu) {
        const categoryProducts = productMenu[category].filter(product =>
          product.ad.toLowerCase().includes(searchTerm)
        );
        foundProducts.push(...categoryProducts); 
      }

      if (foundProducts.length === 0) {
        productListDiv.innerHTML = '<div class="no-product-message">Aranan ürün bulunamadı.</div>';
        return;
      }

      // Arama sonuçlarını da satış sayılarına göre sırala
      if (salesDataLoaded && Object.keys(productSalesCache).length > 0) {
        foundProducts.sort((a, b) => {
          const salesA = productSalesCache[a.ad] || 0;
          const salesB = productSalesCache[b.ad] || 0;
          
          // Önce satış sayısına göre azalan sıralama
          if (salesB !== salesA) {
            return salesB - salesA;
          }
          
          // Satış sayısı aynıysa order'a göre sırala
          return (a.order || 0) - (b.order || 0);
        });
      }

      // Ürünleri direkt göster
      productListDiv.innerHTML = "";
      foundProducts.forEach(product => {
        const div = createProductElement(product);
        productListDiv.appendChild(div);
      });
    }

    function clearSearch() {
      document.getElementById('productSearch').value = '';
      searchProducts();
    }

    // Satış geçmişi güncelleme
    let lastVisibleSale = null;
    const salesPageSize = 10;

    async function updateSalesDisplays() {
      const salesHistoryBody = document.getElementById("salesHistoryBody");
      
      try {
        const refundsSnapshot = await getDocs(collection(db, "refunds"));
        const canceledSnapshot = await getDocs(
          query(collection(db, "sales"), where("canceled", "==", true))
        );

        const refundedOrderIds = refundsSnapshot.docs.map(doc => doc.data().orderId);
        const canceledOrderIds = canceledSnapshot.docs.map(doc => doc.id);

        let q = query(
          collection(db, "sales"), 
          orderBy("timestamp", "desc"), 
          limit(salesPageSize)
        );
        
        if (lastVisibleSale) {
          q = query(q, startAfter(lastVisibleSale));
        }

        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          salesHistoryBody.innerHTML = `<tr><td colspan="5">Henüz sipariş yok</td></tr>`;
          return;
        }

        lastVisibleSale = querySnapshot.docs[querySnapshot.docs.length-1];

        let tbodyContent = "";
        
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const isRefunded = refundedOrderIds.includes(doc.id);
          const isCanceled = canceledOrderIds.includes(doc.id);
          
          let date = "Tarih bilgisi yok";
          if (data.timestamp && typeof data.timestamp.toDate === 'function') {
            date = data.timestamp.toDate().toLocaleString("tr-TR");
          } else if (typeof data.timestamp === "string") {
            date = new Date(data.timestamp).toLocaleString("tr-TR");
          }
          
          const products = data.items.map(i => {
            let productText = `${i.qty}x ${i.product}`;
            if (i.size) productText += ` (${i.size})`;
            return productText;
          }).join(', ');
          
          let status = "Tamamlandı";
          let statusClass = "";
          if (isRefunded) {
            status = "İade Edildi";
            statusClass = "status-canceled";
          } else if (isCanceled) {
            status = "İptal Edildi";
            statusClass = "status-canceled";
          }
          
          const rowClass = isRefunded || isCanceled ? "canceled-order" : "";
          
          tbodyContent += `
            <tr class="${rowClass}">
              <td>${date}</td>
              <td>${doc.id.substring(0, 6)}</td>
              <td>${products}</td>
              <td>${data.total}₺</td>
              <td class="${statusClass}">${status}</td>
            </tr>
          `;
        });
        
        // Yeni kayıtları ekle (sayfalandırma için)
        if (lastVisibleSale) {
          salesHistoryBody.innerHTML += tbodyContent;
        } else {
          salesHistoryBody.innerHTML = tbodyContent;
        }
        
      } catch (error) {
        console.error("Satış geçmişi yüklenirken hata:", error);
        salesHistoryBody.innerHTML = `<tr><td colspan="5">Hata: ${error.message}</td></tr>`;
      }
    }

    // Realtime güncelleme için listener ekle
    onSnapshot(collection(db, "sales"), () => {
      updateSalesDisplays();
      updateSalesCounts();
      // Ürün listesini de güncelle (satış sayıları değiştiği için)
      if (salesDataLoaded) {
        refreshProductDisplay();
      }
    });

    onSnapshot(collection(db, "refunds"), () => {
      updateSalesDisplays();
      updateSalesCounts();
      // Ürün listesini de güncelle (satış sayıları değiştiği için)
      if (salesDataLoaded) {
        refreshProductDisplay();
      }
    });

    let productsLoaded = false;

    async function initializeData() {
      showLoading();
      try {
        // Ürün ve kategorileri sadece bir kere yükle
        if (!productsLoaded) {
          await loadProducts();
          await loadCategories();
          productsLoaded = true;
          
          // Cache'den ürünler yüklendikten sonra UI'ı güncelle
          await updateUIAfterCacheLoad();
        }
        
        // Diğer başlangıç verileri
        await loadStocks();
        await updateSalesDisplays();
        await updateSalesCounts();
        
        // Sadece aktif sipariş için realtime dinleme
        unsubscribeOrder = onSnapshot(doc(db, "active_orders", "tekSiparis"), (doc) => {
          if (doc.exists()) {
            const data = doc.data();
            currentOrder = data.items || [];
            currentCustomerName = data.customerName || "";
            updateOrderDisplay();
          }
        });
        
      } catch (error) {
        console.error("Veri yükleme hatası:", error);
        alert("Veriler yüklenirken bir hata oluştu. Lütfen sayfayı yenileyin.");
      } finally {
        hideLoading();
      }
    }

    async function loadProducts() {
      if (Object.keys(productMenu).length > 0) return; // Zaten yüklüyse tekrar yükleme
      
      try {
        const snapshot = await getDocs(
          query(
            collection(db, "products"),
            orderBy("order"),
            limit(100) // Makul bir limit
          )
        );
        
        productMenu = {};
        productSpecs = {};
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (!data || !data.name) return;

          const category = data.categorySlug || data.category || "Diğer";
          
          if (!productMenu[category]) productMenu[category] = [];

          let imagePath = data.image || `img/${data.name.toLowerCase().replace(/\s/g, '')}.jpg`;
          if (!imagePath.startsWith('http') && !imagePath.startsWith('img/')) {
            imagePath = 'img/' + imagePath;
          }

          if (data.hasSizes && data.sizes) {
            productMenu[category].push({
              ad: data.name,
              resim: imagePath,
              price: Object.values(data.sizes)[0]?.price || 0,
              order: data.order || 0
            });

            productSpecs[data.name] = {
              ...data,
              image: imagePath,
              price: Object.values(data.sizes)[0]?.price || 0
            };
            
            // Ürünü cache'e ekle
            setCache(`product_${data.name}`, productSpecs[data.name]);
          } else {
            productMenu[category].push({
              ad: data.name,
              resim: imagePath,
              price: data.price || 0,
              order: data.order || 0
            });

            productSpecs[data.name] = {
              ...data,
              image: imagePath,
              price: data.price || 0
            };
            
            // Ürünü cache'e ekle
            setCache(`product_${data.name}`, productSpecs[data.name]);
          }
        });
        
        console.log("Ürünler yüklendi ve cache'e eklendi. Kategori sayısı:", Object.keys(productMenu).length);
        
        // Cache yüklendikten sonra UI'ı güncelle
        if (Object.keys(productMenu).length > 0) {
          console.log("Cache'den ürünler yüklendi, UI güncelleniyor...");
        }
      } catch (err) {
        console.error("Ürün yükleme hatası:", err);
        throw err;
      }
    }

    // Stokları yükle
    async function loadStocks() {
      try {
        const querySnapshot = await getDocs(collection(db, "stocks"));
        stockData = {};
        stockCache = {}; // Stok cache'ini temizle
        
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const normalized = normalizeName(data.name);
          stockData[normalized] = {
            quantity: data.quantity,
            docId: doc.id,
            name: data.name
          };
          
          // Stok verilerini cache'e ekle
          stockCache[normalized] = {
            quantity: data.quantity,
            docId: doc.id,
            name: data.name
          };
        });
        
        setCache('stockData', stockCache);
        console.log('Stok verileri cache\'e eklendi');
      } catch (error) {
        console.error("Stok yüklenirken hata:", error);
      }
    }

    // Stok bilgisi al
    async function getStockDoc(itemName) {
      const normalized = normalizeName(itemName);
      const q = query(collection(db, "stocks"), where("name", "==", normalized));
      const snapshot = await getDocs(q);
      return snapshot.docs[0]?.data();
    }

    // Stok güncelle
    async function updateStock(itemName, newQuantity) {
      if (newQuantity < 0) {
        throw new Error(`"${itemName}" stoğu negatif olamaz!`);
      }

      if (!itemName) return false;
      try {
        let q = query(collection(db, "stocks"), where("name", "==", itemName));
        let qs = await getDocs(q);
        if (!qs.empty) {
          const docRef = qs.docs[0].ref;
          await updateDoc(docRef, { name: name.toLowerCase(),quantity: newQuantity, updatedAt: serverTimestamp() });
          return true;
        }

        const allStocksSnap = await getDocs(collection(db, "stocks"));
        for (const docSnap of allStocksSnap.docs) {
          const data = docSnap.data();
          if (normalizeName(data?.name) === normalizeName(itemName)) {
            await updateDoc(docSnap.ref, {
              quantity: newQuantity,
              updatedAt: serverTimestamp()
            });
            return true;
          }
        }

        console.warn(`updateStock: '${itemName}' stok dokümanı bulunamadı.`);
        return false;
      } catch (err) {
        console.error("updateStock error:", err);
        return false;
      }
    }

    // İsimleri standartlaştır
    function normalizeName(name) {
      if (!name) return '';
      return name
        .toString()
        .trim()
        .toLowerCase()
        .replace(/\s+/g, '')
        .replace(/[ıİ]/g, 'i')
        .replace(/[şŞ]/g, 's')
        .replace(/[ğĞ]/g, 'g')
        .replace(/[üÜ]/g, 'u')
        .replace(/[çÇ]/g, 'c')
        .replace(/[öÖ]/g, 'o');
    }

    function extractIngredientMap(obj) {
      if (!obj || typeof obj !== 'object') return {};
      if (obj.ingredients && typeof obj.ingredients === 'object') {
        return obj.ingredients;
      }
      const filtered = {};
      for (const [k, v] of Object.entries(obj)) {
        if (typeof v === 'number') filtered[normalizeName(k)] = v;
      }
      return filtered;
    }
  
    window.confirmOrder = function() {
      if (!Array.isArray(currentOrder) || currentOrder.length === 0) {
        alert("Siparişiniz boş.");
        return;
      }

      const totalPrice = currentOrder.reduce((sum, item) => sum + (item.qty * item.price), 0);
      document.getElementById('paymentTotalAmount').textContent = totalPrice.toFixed(2);
      openModal('paymentModal');
    };

    window.completeOrder = async function(paymentMethod) {
      try {
        // Önce onay sorusunu göster
        const confirmed = confirm(`${calculateTotal().toFixed(2)}₺ tutarındaki siparişi onaylıyor musunuz?\n\nÖdeme yöntemi: ${getPaymentMethodName(paymentMethod)}`);
        
        if (!confirmed) {
          return; // Kullanıcı iptal etti
        }

        const requiredStocks = {};
        let totalPrice = 0;
        let insufficientStocks = [];

        // 1. Adım: Gerekli stok miktarlarını hesapla ve stok kontrolü yap
        for (const item of currentOrder) {
          const spec = productSpecs[item.product];
          if (!spec) continue;

          totalPrice += (item.qty || 0) * (item.price || 0);

          const rawSizeSpec = item.size && spec.sizes && spec.sizes[item.size]
            ? spec.sizes[item.size]
            : spec;

          const ingredients = extractIngredientMap(rawSizeSpec);
          for (const [ingredient, amount] of Object.entries(ingredients)) {
            const ingName = normalizeName(ingredient);
            const requiredAmount = item.qty * amount;
            requiredStocks[ingName] = (requiredStocks[ingName] || 0) + requiredAmount;

            // Stok kontrolü - Artık stockData'dan direkt okuyoruz
            const stockInfo = stockData[ingName];
            if (stockInfo) {
              const currentStock = stockInfo.quantity;
              const totalRequired = requiredStocks[ingName];
              if (currentStock < totalRequired) {
                insufficientStocks.push({
                  name: stockInfo.name,
                  required: totalRequired,
                  available: currentStock
                });
              }
            } else {
              insufficientStocks.push({
                name: ingredient,
                required: item.qty * amount,
                available: 0
              });
            }
          }
        }

        // 2. Adım: Yetersiz stok varsa işlemi durdur
        if (insufficientStocks.length > 0) {
          let errorMessage = "Yetersiz stok:\n";
          insufficientStocks.forEach(stock => {
            errorMessage += `\n${stock.name} - Gereken: ${stock.required}, Mevcut: ${stock.available}`;
          });
          alert(errorMessage);
          return;
        }

        // 3. Adım: Tüm stoklar yeterliyse siparişi kaydet
        const paymentType = getPaymentMethodName(paymentMethod);

        const newOrderRef = await addDoc(collection(db, "sales"), {
          items: currentOrder,
          total: totalPrice,
          timestamp: serverTimestamp(),
          user: currentUserEmail || null,
          customerName: currentCustomerName || null,
          paymentMethod: paymentType,
          isGift: paymentMethod === 'gift'
        });

        if (printReceiptEnabled) {
          await printReceipt(
            newOrderRef.id,
            currentOrder,
            totalPrice,
            currentCustomerName,
            paymentType
          );
        }

        // 4. Adım: Stokları güncelle
        for (const [name, required] of Object.entries(requiredStocks)) {
          const normalized = normalizeName(name);
          const stockInfo = stockData[normalized];
          
          if (!stockInfo) {
            console.warn(`"${name}" malzemesi stok verisinde bulunamadı`);
            continue;
          }

          const newQty = stockInfo.quantity - required;
          const docRef = doc(db, "stocks", stockInfo.docId);
          
          await updateDoc(docRef, {
            quantity: newQty,
            updatedAt: serverTimestamp()
          });
        }

        await deleteDoc(doc(db, "active_orders", "tekSiparis"));
        window.activeOrderId = null;
        currentOrder = [];
        currentCustomerName = "";
        updateOrderDisplay();
        updateSalesDisplays();
        
        closeModal('paymentModal');
        
        if (paymentMethod === 'gift') {
          alert("İkram siparişi başarıyla tamamlandı.");
        } else {
          alert("Sipariş başarıyla tamamlandı.");
        }
      } catch (err) {
        console.error("Sipariş tamamlama hatası:", err);
        alert(err.message || "Sipariş tamamlanırken hata oluştu.");
      }
    };

    // Ödeme yöntemi adını döndüren yardımcı fonksiyon
    function getPaymentMethodName(method) {
      return method === 'gift' ? 'İkram' : 
             method === 'cash' ? 'Nakit' : 
             method === 'card' ? 'Kart' : 
             'Belirtilmedi';
    }

    // FİŞ YAZDIRMA
    async function printReceipt(orderId, items, total, customerName = "", paymentMethod = "") {
      const now = new Date();
      const dateStr = now.toLocaleString("tr-TR");
      const logoUrl = "img/fis_logo.jpg";
      const receiptNumber = await getDailyReceiptNumber();

      const paymentMethodText = paymentMethod === 'cash' ? 'Nakit' : 
                             paymentMethod === 'card' ? 'Kart' : 
                             paymentMethod === 'İkram' ? 'İKRAM' :
                             'Ödeme Yöntemi Belirtilmedi';

      const receiptHtml = `
        <html>
          <head>
            <style>
              @media print {
                @page {
                  margin: 0;
                  padding: 0;
                }
                body {
                  margin: 0 !important;
                  padding: 0 !important;
                  width: 68mm;
                }
              }
              .receipt-container {
                font-family: Times, sans-serif;
                width: 68mm;
                padding: 2px 5px;
                line-height: 1.3;
                font-size: 18px;
                box-sizing: border-box;
              }
              .content-block {
                margin-bottom: 8px;
              }
            </style>
          </head>
          <body>
            <div class="receipt-container">
              <div style="text-align: center; margin-bottom: 5px;">
                <img src="${logoUrl}" alt="Logo" style="max-width: 60mm; height: auto; margin-bottom: 5px;">
                <h2 style="margin: 5px 0; font-size: 20px;">LUMA COFFEE CO.</h2>
              </div>
              <div class="content-block" style="text-align: center;">
                <p style="margin: 4px 0; font-size: 16px;">Sipariş ID: ${orderId}</p>
                <p style="margin: 4px 0; font-size: 16px;">Fiş No: ${receiptNumber.toString().padStart(4, '0')}</p>
              </div>
              <p style="text-align: center; font-size: 16px; margin: 4px 0;">Tarih: ${dateStr}</p>
              ${customerName ? `<p style="text-align: center; font-weight: bold; text-transform: uppercase; font-size: 18px; margin: 4px 0;">${customerName}</p>` : ""}
              <hr style="border-top: 1px dashed #000; margin: 8px 0;">
              <div class="content-block">
                ${items.map(item => `
                  <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                    <span style="flex: 3;">${item.qty}x ${item.product}${item.size ? ` (${item.size})` : ""}</span>
                    <span style="flex: 1; text-align: right;">${(item.qty * item.price).toFixed(2)}₺</span>
                  </div>
                  ${item.note ? `<div style="font-style: italic; font-size: 16px; padding-left: 10px; margin-bottom: 6px;">${item.note}</div>` : ''}
                `).join("")}
              </div>
              <hr style="border-top: 1px dashed #000; margin: 8px 0;">
              <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; margin: 5px 0;">
                <span>TOPLAM:</span>
                <span>${total.toFixed(2)}₺</span>
              </div>
              <div style="margin-top: 5px; text-align: left; font-size: 16px;">
                <span>Ödeme: ${paymentMethodText}</span>
              </div>
              <p style="text-align: center; margin-top: 10px; margin-bottom: 5px; font-size: 16px;">Teşekkür ederiz!</p>
            </div>
          </body>
        </html>
      `;

      const printWindow = window.open("", "_blank");
      printWindow.document.write(receiptHtml);
      printWindow.document.close();

      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
    }

    // İade modalını aç
    async function openRefundModal() {
      selectedRefundItems = [];
      selectedOrderForRefund = null;
      
      const modalContent = `
        <div class="modal-header">
          <h3>İade/Değişim</h3>
          <button class="close-btn" onclick="closeModal('refundModal')">&times;</button>
        </div>
        <h4>Son 10 Sipariş</h4>
        <div id="lastOrdersList" style="max-height: 300px; overflow-y: auto; margin: 15px 0;"></div>
        <div id="orderItemsContainer" style="display:none; margin-top:20px;">
          <h4>İade Edilecek Ürünleri Seçin:</h4>
          <div id="selectedOrderItems"></div>
          <div class="refund-actions" style="margin-top:15px;">
            <button class="btn-danger" onclick="processRefund()">
              <i class="fas fa-undo"></i> İade Yap
            </button>
          </div>
        </div>
      `;
      
      document.querySelector('#refundModal .modal-content').innerHTML = modalContent;
      openModal('refundModal');
      
      await loadLastOrders();
    }

    // Son siparişleri yükle
    async function loadLastOrders() {
      try {
        const refundsSnapshot = await getDocs(collection(db, "refunds"));
        const refundedOrderIds = refundsSnapshot.docs.map(doc => doc.data().orderId);
        
        const q = query(collection(db, "sales"),    
                 orderBy("timestamp", "desc"), 
                 limit(10));
        
        const querySnapshot = await getDocs(q);
        const container = document.getElementById('lastOrdersList');
        container.innerHTML = '';
        
        querySnapshot.forEach(doc => {
          if (refundedOrderIds.includes(doc.id)) return;
          
          const data = doc.data();
          let date = "Tarih bilgisi yok";
          if (data.timestamp && typeof data.timestamp.toDate === 'function') {
            date = data.timestamp.toDate().toLocaleString("tr-TR");
          } else if (typeof data.timestamp === "string") {
            date = new Date(data.timestamp).toLocaleString("tr-TR");
          }
          
          const item = document.createElement('div');
          item.className = 'history-item';
          item.dataset.id = doc.id;
          item.innerHTML = `
            <div class="order-id">Sipariş #${doc.id.slice(0, 6)}</div>
            <div class="items">${data.items.map(i => `${i.qty}x ${i.product}${i.size ? ` (${i.size})` : ''}`).join(', ')}</div>
            <div class="total">${data.total}₺</div>
            <div class="date">${date}</div>
          `;
          
          item.addEventListener('click', function() {
            document.querySelectorAll('.history-item').forEach(el => {
              el.classList.remove('selected');
            });
            this.classList.add('selected');
            selectedOrderForRefund = { id: doc.id, ...data };
            selectOrderForRefund(doc.id, data);
          });
          
          container.appendChild(item);
        });
      } catch (error) {
        console.error("Son siparişler yüklenirken hata:", error);
      }
    }

    // Sipariş seçildiğinde ürünleri listele
    function selectOrderForRefund(orderId, orderData) {
      document.getElementById('orderItemsContainer').style.display = 'block';
      
      let itemsHTML = '';
      orderData.items.forEach((item, index) => {
        itemsHTML += `
          <div class="refund-item">
            <label>
              <input type="checkbox" class="refund-item-checkbox" 
                     data-index="${index}" data-product="${item.product}" 
                     data-qty="${item.qty}" data-price="${item.price}" data-size="${item.size || ''}">
              ${item.qty}x ${item.product}${item.size ? ` (${item.size})` : ''} (${item.price}₺)
            </label>
          </div>
        `;
      });
      
      document.getElementById('selectedOrderItems').innerHTML = itemsHTML;
      
      // Checkbox event listener'ları ekle
      document.querySelectorAll('.refund-item-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const itemData = {
            index: parseInt(this.dataset.index),
            product: this.dataset.product,
            qty: parseInt(this.dataset.qty),
            price: parseFloat(this.dataset.price),
            size: this.dataset.size
          };
          
          if (this.checked) {
            selectedRefundItems.push(itemData);
          } else {
            selectedRefundItems = selectedRefundItems.filter(
              item => item.index !== itemData.index
            );
          }
        });
      });
    }

    // İade işlemi
    async function processRefund() {
      if (selectedRefundItems.length === 0) {
        alert('Lütfen iade edilecek ürünleri seçin');
        return;
      }

      if (!selectedOrderForRefund) {
        alert('Sipariş seçilmedi');
        return;
      }

      // Onay modalını aç
      openModal('refundConfirmModal');
    }

    // İade onayı
    async function refundConfirm(restock) {
      try {
        console.log("Seçilen iade öğeleri:", selectedRefundItems);
        console.log("Sipariş verisi:", selectedOrderForRefund);

        // 1. İade kaydı oluştur
        const refundRef = await addDoc(collection(db, "refunds"), {
          orderId: selectedOrderForRefund.id,
          items: selectedRefundItems,
          timestamp: serverTimestamp(),
          user: currentUserEmail,
          restock: restock
        });
        console.log("İade kaydı oluşturuldu ID:", refundRef.id);

        // 2. Stok güncelleme (restock true ise)
        if (restock) {
          for (const item of selectedRefundItems) {
            const spec = productSpecs[item.product];
            if (!spec) {
              console.warn("Ürün spesifikasyonu bulunamadı:", item.product);
              continue;
            }

            const sizeSpec = item.size ? spec.sizes?.[item.size] : spec;
            const ingredients = extractIngredientMap(sizeSpec || spec);
            console.log("Ürün malzemeleri:", ingredients);

            for (const [ingredient, amount] of Object.entries(ingredients)) {
              const stockDoc = await getStockDoc(ingredient);
              if (!stockDoc) {
                console.error("Stok bulunamadı:", ingredient);
                continue;
              }

              const newQty = stockDoc.quantity + (amount * item.qty);
              await updateStock(ingredient, newQty);
              console.log(`Stok güncellendi: ${ingredient} -> ${newQty}`);
            }
          }
        }

        alert("✅ İade işlemi başarıyla tamamlandı");
        closeModal('refundModal');
        closeModal('refundConfirmModal');
        updateSalesDisplays();

      } catch (error) {
        console.error("‼️ İade hatası:", error);
        alert(`İade sırasında hata: ${error.message}`);
      }
    }

    // Collapsible bölümler
    document.querySelectorAll(".collapsible").forEach(btn => {
      btn.addEventListener("click", function() {
        this.classList.toggle("active");
        const content = this.nextElementSibling;
        const expanded = content.style.display === "block";
        content.style.display = expanded ? "none" : "block";
        this.setAttribute("aria-expanded", !expanded);
        
        const icon = this.querySelector('.fa-chevron-down');
        if (icon) {
          icon.classList.toggle('fa-chevron-down', expanded);
          icon.classList.toggle('fa-chevron-up', !expanded);
        }
      });
    });

    // DOM yüklendiğinde
    document.addEventListener("DOMContentLoaded", async () => {
      // Arama input'una event listener ekle
      document.getElementById('productSearch').addEventListener('input', searchProducts);
      
      // Theme'i yükle
      loadTheme();
      
      // Cache temizleme işlemini periyodik olarak çalıştır
      setInterval(clearExpiredCache, CACHE_DURATION);
      
      // Cache durumunu console'da göster (debug için)
      setInterval(() => {
        const cacheSize = Object.keys(productCache).length;
        const stockCacheSize = Object.keys(stockCache).length;
        console.log(`Cache Durumu - Ürünler: ${cacheSize}, Stok: ${stockCacheSize}`);
      }, 30000); // 30 saniyede bir
      
      // Kullanıcı giriş kontrolü
      //onAuthStateChanged(auth, async (user) => {
        //if (!user) {
         // alert("Lütfen önce giriş yapınız.");
          //window.location.href = "index.html";
          //return;
       // }
        
       // currentUserEmail = user.email;
        //await initializeData();
      //});
await initializeData();   //giriş kontrolü kaldırıldı, veri yükleme direkt başlatılıyor. tekrar açınca sil
      

      // Fiş yazdırma toggle butonu
      const toggleBtn = document.getElementById('receiptToggle');
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          printReceiptEnabled = !printReceiptEnabled;
          localStorage.setItem('printReceiptEnabled', printReceiptEnabled);
          
          if (printReceiptEnabled) {
            toggleBtn.innerHTML = '<i class="fas fa-receipt"></i> Fiş Yazdırma: Açık';
            toggleBtn.classList.remove('off');
          } else {
            toggleBtn.innerHTML = '<i class="fas fa-receipt"></i> Fiş Yazdırma: Kapalı';
            toggleBtn.classList.add('off');
          }
        });
        
        // Başlangıç durumunu yükle
        const savedSetting = localStorage.getItem('printReceiptEnabled');
        if (savedSetting !== null) {
          printReceiptEnabled = JSON.parse(savedSetting);
        }
        
        if (!printReceiptEnabled) {
          toggleBtn.innerHTML = '<i class="fas fa-receipt"></i> Fiş Yazdırma: Kapalı';
          toggleBtn.classList.add('off');
        }
      }
      
      // Theme toggle butonuna event listener ekle
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
      }
      
      // Refresh butonuna event listener ekle
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
          refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Güncelleniyor...';
          refreshBtn.disabled = true;
          
          try {
            await refreshProductDisplay();
            refreshBtn.innerHTML = '<i class="fas fa-check"></i> Güncellendi!';
            setTimeout(() => {
              refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Sayfayı Yenile';
              refreshBtn.disabled = false;
            }, 2000);
          } catch (error) {
            console.error('Güncelleme hatası:', error);
            refreshBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Hata!';
            setTimeout(() => {
              refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Sayfayı Yenile';
              refreshBtn.disabled = false;
            }, 3000);
          }
        });
      }
    });

        // Global fonksiyonlar
 window.changeQty = changeQty;
    window.addToOrder = addToOrder;
    window.removeFromOrder = removeFromOrder;
    window.openRefundModal = openRefundModal;
    window.processRefund = processRefund;
    window.refundConfirm = refundConfirm;
    window.clearSearch = clearSearch;
    window.addCustomerName = addCustomerName;
    window.submitName = submitName;
    window.openNoteModal = openNoteModal;
    window.saveNote = saveNote;
    window.selectSize = selectSize;
    window.completeOrder = completeOrder;
    window.confirmOrder = confirmOrder;
    window.closeModal = closeModal;
    window.refreshProductDisplay = refreshProductDisplay;
    window.showProductsLoading = showProductsLoading;
    window.showSkeletonLoading = showSkeletonLoading;
    window.clearExpiredCache = clearExpiredCache;
    window.getCache = getCache;
    window.setCache = setCache;
    window.setTheme = setTheme;
    window.toggleTheme = toggleTheme;
    window.loadTheme = loadTheme;
    window.updateUIAfterCacheLoad = updateUIAfterCacheLoad;

    // Cache'den ürünler yüklendikten sonra UI'ı güncelle
    async function updateUIAfterCacheLoad() {
      try {
        // Skeleton loading'i kaldır
        const productListDiv = document.getElementById("kahveListesi");
        if (productListDiv && productListDiv.querySelector('.skeleton-product')) {
          productListDiv.innerHTML = "";
        }
        
        // Cache'den ürünler yüklendiyse ilk kategoriyi otomatik seç
        if (Object.keys(productMenu).length > 0) {
          const firstMainBtn = document.querySelector('.main-category-btn');
          if (firstMainBtn && !firstMainBtn.classList.contains('active')) {
            console.log('İlk kategori otomatik seçiliyor...');
            firstMainBtn.click(); // İlk kategoriyi otomatik seç
          }
        }
        
        console.log('UI cache yüklemesi sonrası güncellendi');
      } catch (error) {
        console.error('UI güncelleme hatası:', error);
      }
    }
    
    // Satış verilerini güncelle ve ürün listesini yenile
    async function refreshProductDisplay() {
      await updateSalesCounts();
      
      // Aktif kategoriyi yeniden yükle
      const activeMainBtn = document.querySelector('.main-category-btn.active');
      if (activeMainBtn) {
        const mainCatId = activeMainBtn.dataset.id;
        const mainCatSlug = activeMainBtn.dataset.slug;
        const mainCat = { id: mainCatId, slug: mainCatSlug };
        
        // Alt kategorileri yeniden yükle
        const contentArea = document.getElementById('categoryContent');
        if (contentArea.classList.contains('active')) {
          const activeSubBtn = contentArea.querySelector('.subcategory-btn.active');
          if (activeSubBtn) {
            selectSubCategory(activeSubBtn.dataset.slug);
          } else {
            listProducts(mainCatSlug);
          }
        } else {
          listProducts(mainCatSlug);
        }
      }
    }

    // Global fonksiyonlar
  </script>
</body>
</html>